@model Tuple<MatchFixer_Web_App.Areas.Admin.ViewModels.Teams.TeamSearchVm,
	MatchFixer_Web_App.Areas.Admin.ViewModels.Teams.PaginatedTeamsList<
		MatchFixer_Web_App.Areas.Admin.ViewModels.Teams.TeamListRow>>
@using System.Text.RegularExpressions


@{
    Layout = "/Areas/Admin/Views/Shared/_Layout.Admin.cshtml";
    ViewData["Title"] = "Add a missing Team";

    var vm = Model.Item1;
    var leagues = vm.Leagues ?? new Dictionary<int, string>();
    var existing = Model.Item2;

    var leagueFlags = new Dictionary<string, string>
    {
	    { "Premier League", "https://media.api-sports.io/flags/gb.svg" },
	    { "La Liga",        "https://media.api-sports.io/flags/es.svg" },
	    { "Bundesliga",     "https://media.api-sports.io/flags/de.svg" },
	    { "Serie A",        "https://media.api-sports.io/flags/it.svg" },
	    { "Ligue 1",        "https://media.api-sports.io/flags/fr.svg" },
	    { "Eredivisie",     "https://media.api-sports.io/flags/nl.svg" },
	    { "Liga Portugal",  "https://media.api-sports.io/flags/pt.svg" },
	    { "Ekstraklasa",    "https://media.api-sports.io/flags/pl.svg" },
	    { "Swiss Super League", "https://media.api-sports.io/flags/ch.svg" },
	    { "Parva Liga", "https://media.api-sports.io/flags/bg.svg" },
		{ "Polish League Ekstraklasa", "https://media.api-sports.io/flags/pl.svg" },
		{ "Swiss League", "https://media.api-sports.io/flags/ch.svg" }
    };

    var selectedIds = new HashSet<int>(vm.SelectedLeagueIds ?? Array.Empty<int>());

}

<div class="background-profile"></div>

<div class="border-0 rounded-4 p-4 flex-fill">
	@if (TempData["SuccessMessage"] != null)
	{
		<div class="alert success-message">@TempData["SuccessMessage"]</div>
	}
	@if (TempData["ErrorMessage"] != null)
	{
		<div class="alert error-message">@TempData["ErrorMessage"]</div>
	}
</div>


<div class="admin-teams-container">
    <div class="row g-2">
        <div class="col-12 col-xl-6">
	        <div class="card">
		        @functions{
			        string Slug(string s) => Regex.Replace((s ?? "").ToLowerInvariant(), "[^a-z0-9]+", "-").Trim('-');
		        }

				<div class="d-flex flex-wrap align-items-center justify-content-center gap-2 mb-2">
					<div class="league-btn-group d-flex flex-wrap gap-3 align-items-center justify-content-center" role="group" aria-label="League filters">
				        @foreach (var kv in leagues.OrderBy(x => x.Value))
				        {
					        var id = kv.Key;
					        var name = kv.Value;
					        var inputId = $"pill-{id}";
					        var flagUrl = leagueFlags.TryGetValue(name, out var f)
						        ? f
						        : "https://media.api-sports.io/flags/eu.svg";

					        <input class="league-pill" id="@inputId" type="checkbox"
					               value="@id" @(selectedIds.Contains(id) ? "checked" : null) />
					        <label class="flag-pill" for="@inputId"
					               title="@name" style="--flag:url('@flagUrl')">

					        </label>
				        }
			        </div>

			       
		        </div>
		        <div class="d-flex justify-content-center align-items-center">
			        <button type="button" class="btn btn-light btn-sm ms-1" id="leagueClear">Clear</button>
			        <button type="button" class="btn btn-light btn-sm" id="leagueSelectAll">Select all</button>
		        </div>
				<h3 class="h5 mb-1 mt-1 text-center">Existing Teams</h3>
		        <div class="table-responsive existing-teams-table">
			        <table class="table align-middle table-fixed w-100">
				        <colgroup>
					        <col style="width:80px" />
					        <col style="width:60%" />
					        <col style="width:100px" />
							<col style="width:200px" />
				        </colgroup>
				        <thead>
				        <tr>
					        <th class="text-center">Logo</th>
					        <th class="text-center">Name</th>
					        <th class="text-center">API Id</th>
					        <th class="text-center">League</th>
				        </tr>
				        </thead>
				        <tbody>
				        @foreach (var t in existing.Items)
				        {
					        <tr data-league-slug="@Slug(t.LeagueName)">
						        <td class="text-center" style="width:40px"><img src="@t.LogoUrl" alt="" style="width:40px;height:40px;object-fit:contain" title="@t.Name"/></td>
						        <td class="text-center">@t.Name</td>
						        <td class="text-center align-middle">
							        <span class="badge bg-info d-inline-flex align-items-center justify-content-center"
							              style="min-width:45px; height:24px;">
								        @t.ApiTeamId
							        </span>
						        </td>
						        <td class="text-center">
							        @{
								        string flag = leagueFlags.TryGetValue(t.LeagueName, out var url)
									        ? url
									        : "https://media.api-sports.io/flags/eu.svg";
							        }
							        <img src="@flag"
							             alt="@t.LeagueName flag"
							             title="@t.LeagueName"
							             style="width:18px;height:12px;object-fit:contain;margin-right:6px;vertical-align:middle"/>
							        @t.LeagueName
						        </td>
					        </tr>
				        }

				        </tbody>

				        <tfoot>
				        <tr>
					        <td colspan="4">
						        <div class="teams-pages">
							        <ul class="pagination mb-0">

								        @{
									        var p = existing.Page;
									        var total = existing.TotalPages;
									        const int window = 10;

									        var start = ((p - 1) / window) * window + 1;
									        var end = Math.Min(start + window - 1, total);

									        var selectedIdsArr = vm.SelectedLeagueIds ?? Array.Empty<int>();

									        string Link(int i) => Url.Action(
										        "TeamsIndex",
										        "AdminTeams",
										        new { area = "Admin", page = i, leagueIds = selectedIdsArr } // <- pass the array
									        )!;

									        int prevWindowStart = Math.Max(1, start - window);
									        int nextWindowStart = Math.Min(((total - 1) / window) * window + 1, start + window);
								        }

								        <ul class="pagination mb-0">
									        <!-- First / Prev -->
									        <li class="page-item @(p == 1 ? "disabled" : null)">
										        <a class="page-link" href="@(p == 1 ? "#" : Link(1))" aria-label="First">&laquo;</a>
									        </li>
									        <li class="page-item @(p == 1 ? "disabled" : null)">
										        <a class="page-link" href="@(p == 1 ? "#" : Link(p - 1))" aria-label="Previous">&lsaquo;</a>
									        </li>

									        <!-- Jump back a window -->
									        @if (start > 1)
									        {
										        <li class="page-item">
											        <a class="page-link" href="@Link(prevWindowStart)" title="Previous 10">…</a>
										        </li>
									        }

									        <!-- Window pages -->
									        @for (var i = start; i <= end; i++)
									        {
										        <li class="page-item @(i == p ? "active" : null)">
											        <a class="page-link" href="@Link(i)">@i</a>
										        </li>
									        }

									        <!-- Jump forward a window -->
									        @if (end < total)
									        {
										        <li class="page-item">
											        <a class="page-link" href="@Link(nextWindowStart)" title="Next 10">…</a>
										        </li>
									        }

									        <!-- Next / Last -->
									        <li class="page-item @(p == total ? "disabled" : null)">
										        <a class="page-link" href="@(p == total ? "#" : Link(p + 1))" aria-label="Next">&rsaquo;</a>
									        </li>
									        <li class="page-item @(p == total ? "disabled" : null)">
										        <a class="page-link" href="@(p == total ? "#" : Link(total))" aria-label="Last">&raquo;</a>
									        </li>
								        </ul>

							        </ul>
						        </div>
					        </td>
				        </tr>
				        </tfoot>
			        </table>
		        </div>


	        </div>
        </div>

        <div class="col-12 col-xl-6">
            <div class="card p-2 d-flex justify-content-center align-items-center">
                <h3 class="h5 mb-3">Search & Add</h3>

                <form asp-area="Admin" asp-controller="AdminTeams" asp-action="Search" method="post" class="d-flex flex-wrap gap-2 align-items-end">
	                @Html.AntiForgeryToken()
					<div class="d-flex flex-column justify-content-center align-items-center">
		                <label class="form-label text-center">Team name</label>
		                <input name="Query" value="@vm.Query" class="form-control" placeholder="e.g., Manchester United" required />
	                </div>
	                <button class="btn btn-primary">Search</button>
                </form>

                @if (vm.Results.Any())
                {
                    <div class="d-flex align-items-center gap-2 mt-3">
                        <label class="form-label m-0">Assign to league:</label>
                        <select id="assignLeague" class="form-select form-select-sm" style="width:auto">
                            @foreach (var kv in leagues)
                            {
                                <option value="@kv.Key">@kv.Value</option>
                            }
                        </select>
                    </div>

                    <div class="table-responsive mt-3">
                        <table class="table align-middle">
                            <thead>
                                <tr>
                                    <th style="width:48px">Logo</th>
                                    <th>Name</th>
                                    <th>API Id</th>
                                    <th class="text-end"></th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var r in vm.Results)
                                {
                                    <tr>
                                        <td><img src="@r.LogoUrl" alt="" style="width:35px;height:35px;object-fit:contain" /></td>
                                        <td>@r.Name</td>
                                        <td>@r.ApiTeamId</td>
                                        <td class="text-end">
                                            <form asp-action="Add" method="post" class="d-inline">
                                                @Html.AntiForgeryToken()
                                                <input type="hidden" name="apiTeamId" value="@r.ApiTeamId" />
                                                <input type="hidden" name="name" value="@r.Name" />
                                                <input type="hidden" name="logoUrl" value="@r.LogoUrl" />
                                                <input type="hidden" name="leagueId" value="@r.LeagueId" data-bind-league />
                                                <button class="btn btn-success btn-sm">Add</button>
                                            </form>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <script>

                        (function(){
                            const sel = document.getElementById('assignLeague');
                            function sync() {
                                document.querySelectorAll('input[data-bind-league]').forEach(i => i.value = sel.value);
                            }
                            sel.addEventListener('change', sync);
                            sync();
                        })();
                    </script>
                }
                else if (!string.IsNullOrWhiteSpace(vm.Query))
                {
                    <p class="text-muted mt-3">No results for “@vm.Query”. Try exact name spelling or a shorter search.</p>
                }
            </div>
        </div>
    </div>
</div>

								
<script>
	(function () {
	  const pills = Array.from(document.querySelectorAll('.league-pill'));
	  const btnClear = document.getElementById('leagueClear');
	  const btnAll   = document.getElementById('leagueSelectAll');

	  const baseUrl = '@Url.Action("TeamsIndex", "AdminTeams", new { area = "Admin" })';

	  function goToFiltered(ids){
		const qs = new URLSearchParams();
		qs.set('page', '1');                 
		(ids || []).forEach(id => qs.append('leagueIds', id));
		window.location.href = `${baseUrl}?${qs.toString()}`;
	  }

	  function currentSelection(){
		return pills.filter(p => p.checked).map(p => p.value);
	  }

	  pills.forEach(p => p.addEventListener('change', () => {
		goToFiltered(currentSelection());
	  }));

	  btnClear?.addEventListener('click', () => {
		pills.forEach(p => p.checked = false);
		goToFiltered([]);
	  });

	  btnAll?.addEventListener('click', () => {
		pills.forEach(p => p.checked = true);
		goToFiltered(currentSelection());
	  });
	})();
</script>

