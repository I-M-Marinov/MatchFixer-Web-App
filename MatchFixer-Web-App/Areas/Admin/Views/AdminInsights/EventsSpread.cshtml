@using MatchFixer_Web_App.Areas.Admin.ViewModels.Events
@model PaginatedEventList<EventBetStatsRow>
@{
    Layout = "/Areas/Admin/Views/Shared/_Layout.Admin.cshtml";
    ViewData["Title"] = "Events — Bet Spread";

    var leagueFlags = new Dictionary<string, string>
    {
	    { "Premier League", "https://media.api-sports.io/flags/gb.svg" },
	    { "La Liga",        "https://media.api-sports.io/flags/es.svg" },
	    { "Bundesliga",     "https://media.api-sports.io/flags/de.svg" },
	    { "Serie A",        "https://media.api-sports.io/flags/it.svg" },
	    { "Ligue 1",        "https://media.api-sports.io/flags/fr.svg" },
	    { "Eredivisie",     "https://media.api-sports.io/flags/nl.svg" },
	    { "Liga Portugal",  "https://media.api-sports.io/flags/pt.svg" },
	    { "Ekstraklasa",    "https://media.api-sports.io/flags/pl.svg" },
	    { "Swiss Super League", "https://media.api-sports.io/flags/ch.svg" },
	    { "Parva Liga", "https://media.api-sports.io/flags/bg.svg" },
	    { "Polish League Ekstraklasa", "https://media.api-sports.io/flags/pl.svg" },
	    { "Swiss League", "https://media.api-sports.io/flags/ch.svg" }
    };

    var leagueLogos = new Dictionary<string, int>
    {
	    ["Premier League"] = 39,
	    ["Parva Liga"] = 172,
	    ["Bundesliga"] = 78,
	    ["La Liga"] = 140,
	    ["Eredivisie"] = 88,
	    ["Ligue 1"] = 61,
	    ["Serie A"] = 135,
	    ["Liga Portugal"] = 94,
	    ["Swiss League"] = 207,
	    ["Polish League Ekstraklasa"] = 106
    };

}

<div class="background-profile"></div>


<div class="card events-spread-card p-3" style="background-color: rgba(0, 0, 0, 0.3); padding: 1.5em 2em; border-radius: 0.35em; z-index: 2;">
    <h3 class="h5 mb-3 text-center text-black">Upcoming Events — Bet Distribution</h3>

    @if (!Model.Items.Any())
    {
        <p class="text-muted">No upcoming events.</p>
    }
    else
    {
	    <div id="leagueFilterPills" class="league-pills">
		    <button class="league-pill active" data-league="all" title="All leagues">
			    <i class="bi bi-globe"></i>
		    </button>
	    </div>

	    <div class="table-responsive admin-bets-spread-table">
            <table class="table align-middle">
                <thead>
                    <tr>
						<th class="text-center">Event</th>
                        <th class="league-name">League</th>
                        <th class="text-center">Kick Off</th>
                        <th class="text-center">Total Stake</th>
                        <th class="text-center">Total Bets</th>
                        <th class="text-center" style="min-width:220px">
                            <span class="progress-home badge"> Home </span>
                            |
                            <span class="progress-draw badge"> Draw </span>
                            |
                            <span class="progress-away badge"> Away </span>
                        </th>
                    </tr>
                </thead>
                <tbody>
                @foreach (var r in Model.Items)
                {
                    <tr data-event-id="@r.EventId" data-league="@r.LeagueName">
                        <td class="text-center">
                                <img src="@r.HomeTeamLogoUrl" alt="" style="width:40px;height:40px;object-fit:contain;margin-left: 1.5em;" title="@r.HomeTeam" />
                                <img src="/images/live-events/versus.png" style="width: auto; height: 16px; margin: 0em 0.5em 0em 0.5em;" class="img-fluid">
                                <img src="@r.AwayTeamLogoUrl" alt="" style="width:40px;height:40px;object-fit:contain;" title="@r.AwayTeam" />
		                </td>
		                @{
			                string flag = leagueFlags.TryGetValue(r.LeagueName, out var url)
				                ? url
				                : "https://media.api-sports.io/flags/eu.svg";
		                }
		                <td class="league-name d-flex align-items-center justify-content-center gap-2 p-3">
			                <img src="@flag" alt="@r.LeagueName flag" title="@r.LeagueName" style="width:25px;height:25px;object-fit:contain;" />
			                <span class="mb-0">@r.LeagueName</span>
		                </td>
		                <td>
			                @{
				                var local = r.KickoffUtc.ToLocalTime();
				                var formatted =
					                $"{Ordinal(local.Day)} " +
					                $"{local:MMM yyyy} at {local:h:mm tt}";
			                }

			                <span class="mb-0">@formatted</span>
		                </td>
                        <td class="text-center fw-semibold  @(r.TotalBets == 0 ? "text-primary" : "text-black")" data-role="total-stake">
			                @r.TotalStake.ToString("C", new System.Globalization.CultureInfo("en-IE"))
		                </td>
		                <td class="text-center fw-semibold @(r.TotalBets == 0 ? "current-odds-cell text-primary" : "text-black")"
		                    data-role="total-bets">
			                @(r.TotalBets == 0 ? "current odds" : r.TotalBets)
		                </td>
		                <td>
			                <div class="d-flex align-items-center gap-2">
				                <div class="progress flex-grow-1" style="height: 25px; font-size: 0.65rem;">
                                    @if (r.TotalStake == 0)
                                    {
	                                    <div class="progress-bar projected-home text-center" style="width:@r.HomePct%">@(r.HomePct > 5 ? $"{r.HomePct}%" : "")</div>
                                        <div class="progress-bar projected-draw text-center" style="width:@r.DrawPct%">@(r.DrawPct > 5 ? $"{r.DrawPct}%" : "")</div>
                                        <div class="progress-bar projected-away text-center" style="width:@r.AwayPct%">@(r.AwayPct > 5 ? $"{r.AwayPct}%" : "")</div>
                                    }
                                    else
                                    {
	                                    <div class="progress-bar progress-home text-center" style="width:@r.HomePct%">@(r.HomePct > 5 ? $"{r.HomePct}%" : "")</div>
	                                    <div class="progress-bar progress-draw text-center" style="width:@r.DrawPct%">@(r.DrawPct > 5 ? $"{r.DrawPct}%" : "")</div>
	                                    <div class="progress-bar progress-away text-center" style="width:@r.AwayPct%">@(r.AwayPct > 5 ? $"{r.AwayPct}%" : "")</div>
                                    }
					              
				                </div>
			                </div>
		                </td>
	                </tr>
                }
                </tbody>

                <tfoot>
                <tr>
	                <td colspan="6">
		                @{
			                var p = Model.Page;
			                var total = Model.TotalPages;
			                string Link(int i) => Url.Action("EventsSpread", "AdminInsights", new { area = "Admin", page = i })!;
		                }
		                <ul class="pagination pagination-ivm mb-0 d-flex justify-content-center">
			                <li class="page-item @(p == 1 ? "disabled" : null)">
				                <a class="page-link" href="@(p == 1 ? "#" : Link(1))">&laquo;</a>
			                </li>
			                <li class="page-item @(p == 1 ? "disabled" : null)">
				                <a class="page-link" href="@(p == 1 ? "#" : Link(p - 1))">&lsaquo;</a>
			                </li>
			                @for (var i = Math.Max(1, p - 3); i <= Math.Min(total, p + 3); i++)
			                {
				                <li class="page-item @(i == p ? "active" : null)">
					                <a class="page-link" href="@Link(i)">@i</a>
				                </li>
			                }
			                <li class="page-item @(p == total ? "disabled" : null)">
				                <a class="page-link" href="@(p == total ? "#" : Link(p + 1))">&rsaquo;</a>
			                </li>
			                <li class="page-item @(p == total ? "disabled" : null)">
				                <a class="page-link" href="@(p == total ? "#" : Link(total))">&raquo;</a>
			                </li>
		                </ul>
	                </td>
                </tr>
                <div class="odds-color-map">
	                <span class="me-2 text-primary" style="font-size: 0.65em;">
		                odds: 
	                </span> 
	                <span class="projected-home badge"> Home </span>
	                |
	                <span class="projected-draw badge"> Draw </span>
	                |
	                <span class="projected-away badge"> Away </span>
                </div>
                </tfoot>
            </table>
        </div>
    }
</div>

									
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>

<script>

	const leagueLogoMap = @Html.Raw(Json.Serialize(leagueLogos));


    (function(){
      const hubUrl = "/hubs/admin-insights";

      const connection = new signalR.HubConnectionBuilder()
        .withUrl(hubUrl)
        .withAutomaticReconnect()
        .build();

      function rowFor(eventId) {
        return document.querySelector(`tr[data-event-id="${eventId}"]`);
      }

      function setPctBar(el, pct) {
        if (!el) return;
        const v = Number(pct) || 0;
        el.style.width = v + "%";

        el.textContent = v > 5 ? (v.toFixed(2) + "%") : "";
      }

        function setTotalStake(row, totalStake) {
          const cell = row.querySelector('[data-role="total-stake"]');
          if (!cell) return;


          cell.textContent = `€${Number(totalStake).toFixed(2)}`;
          cell.classList.toggle("text-danger", (totalStake || 0) <= 0);
          cell.classList.toggle("text-dark", (totalStake || 0) > 0);
        }

        function setTotalCell(row, total) {
          const cell = row.querySelector('[data-role="total-bets"]');
          if (!cell) return;
          cell.textContent = total;
          cell.classList.toggle("text-danger", total == 0);
          cell.classList.toggle("text-dark",   total != 0);
        }

      connection.on("BetMixUpdated", function (m) {
        const row = rowFor(m.eventId);
        if (!row) return;

        setPctBar(row.querySelector(".progress-home"), m.homePct);
        setPctBar(row.querySelector(".progress-draw"), m.drawPct);
        setPctBar(row.querySelector(".progress-away"), m.awayPct);
        setTotalCell(row, m.totalBets);
        setTotalStake(row, m.totalStake);

      });

      connection.start().then(function(){

        document.querySelectorAll("tr[data-event-id]").forEach(tr => {
          const id = tr.getAttribute("data-event-id");
          if (id) connection.invoke("JoinEvent", id);
        });
      }).catch(err => console.error("[AdminInsightsHub] connect error", err));


      window.addEventListener("beforeunload", function(){
        document.querySelectorAll("tr[data-event-id]").forEach(tr => {
          const id = tr.getAttribute("data-event-id");
          if (id) connection.invoke("LeaveEvent", id);
        });
      });
    })();

	document.addEventListener("DOMContentLoaded", () => {

		const pillContainer = document.getElementById("leagueFilterPills");
		if (!pillContainer) return;

		const params = new URLSearchParams(window.location.search);
		const selectedLeague = params.get("league");

		/* -----------------------------
		   CREATE "ALL" BUTTON
		-------------------------------- */
		const allBtn = document.createElement("button");
		allBtn.className = "league-filter-pill";
		allBtn.dataset.league = "all";
		allBtn.title = "All leagues";
		allBtn.innerHTML = `<i class="bi bi-globe"></i>`;

		if (!selectedLeague) {
			allBtn.classList.add("active");
		}

		pillContainer.appendChild(allBtn);

		/* -----------------------------
		   CREATE LEAGUE PILLS
		-------------------------------- */
		Object.entries(leagueLogoMap).forEach(([league, leagueId]) => {

			const btn = document.createElement("button");
			btn.className = "league-filter-pill";
			btn.dataset.league = league;
			btn.title = league;

			if (selectedLeague === league) {
				btn.classList.add("active");
			}

			const img = document.createElement("img");
			img.src = `https://media.api-sports.io/football/leagues/${leagueId}.png`;
			img.alt = league;

			btn.appendChild(img);
			pillContainer.appendChild(btn);
		});

		/* -----------------------------
		   NAVIGATION LOGIC
		-------------------------------- */
		pillContainer.addEventListener("click", e => {
			const btn = e.target.closest(".league-filter-pill");
			if (!btn) return;

			const league = btn.dataset.league;

			const url = new URL(window.location.href);
			if (league === "all") {
				url.searchParams.delete("league");
			} else {
				url.searchParams.set("league", league);
				url.searchParams.set("page", 1);
			}

			window.location.href = url.toString();
		});
	});

	@functions {
		string Ordinal(int day)
		{
			if (day % 100 is >= 11 and <= 13)
				return $"{day}th";

			return (day % 10) switch
			{
				1 => $"{day}st",
				2 => $"{day}nd",
				3 => $"{day}rd",
				_ => $"{day}th"
			};
		}
	}



</script>