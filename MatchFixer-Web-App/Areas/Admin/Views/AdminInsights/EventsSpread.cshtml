@using MatchFixer_Web_App.Areas.Admin.ViewModels.Events
@model PaginatedEventList<EventBetStatsRow>
@{
    Layout = "/Areas/Admin/Views/Shared/_Layout.Admin.cshtml";
    ViewData["Title"] = "Events — Bet Spread";

    var leagueFlags = new Dictionary<string, string>
    {
	    { "Premier League", "https://media.api-sports.io/flags/gb.svg" },
	    { "La Liga",        "https://media.api-sports.io/flags/es.svg" },
	    { "Bundesliga",     "https://media.api-sports.io/flags/de.svg" },
	    { "Serie A",        "https://media.api-sports.io/flags/it.svg" },
	    { "Ligue 1",        "https://media.api-sports.io/flags/fr.svg" },
	    { "Eredivisie",     "https://media.api-sports.io/flags/nl.svg" },
	    { "Liga Portugal",  "https://media.api-sports.io/flags/pt.svg" },
	    { "Ekstraklasa",    "https://media.api-sports.io/flags/pl.svg" },
	    { "Swiss Super League", "https://media.api-sports.io/flags/ch.svg" },
	    { "Parva Liga", "https://media.api-sports.io/flags/bg.svg" },
	    { "Polish League Ekstraklasa", "https://media.api-sports.io/flags/pl.svg" },
	    { "Swiss League", "https://media.api-sports.io/flags/ch.svg" }
    };
}

<div class="background-profile"></div>


<div class="card events-spread-card p-3">
    <h3 class="h5 mb-3 text-center">Upcoming Events — Bet Distribution</h3>

    @if (!Model.Items.Any())
    {
        <p class="text-muted">No upcoming events.</p>
    }
    else
    {
        <div class="table-responsive">
            <table class="table align-middle">
                <thead>
                    <tr>
	                    <th>Event</th>
                        <th class="league-name">League</th>
                        <th class="text-center">Total Stake</th>
                        <th class="text-center">Total Bets</th>
                        <th class="text-center" style="min-width:220px">
                            <span class="progress-home badge"> Home </span>
                            /
                            <span class="progress-draw badge"> Draw </span>
                            /
                            <span class="progress-away badge"> Away </span>
                        </th>
                    </tr>
                </thead>
                <tbody>
                @foreach (var r in Model.Items)
                {
	                <tr data-event-id="@r.EventId">
		                <td>@r.HomeTeam <span class="text-muted">vs</span> @r.AwayTeam</td>
		                @{
			                string flag = leagueFlags.TryGetValue(r.LeagueName, out var url)
				                ? url
				                : "https://media.api-sports.io/flags/eu.svg";
		                }
		                <td class="league-name d-flex align-items-center justify-content-start gap-2">
			                <img src="@flag" alt="@r.LeagueName flag" title="@r.LeagueName"
			                     style="width:25px;height:16px;object-fit:contain;"/>
			                <span class="mb-0">@r.LeagueName</span>
		                </td>
			                <td class="text-center fw-semibold" data-role="total-stake">
				                @r.TotalStake.ToString("C", new System.Globalization.CultureInfo("en-IE"))
			                </td>
	                        <td class="text-center fw-semibold @(r.TotalBets == 0 ? "text-danger" : "text-dark")" data-role="total-bets">
								@r.TotalBets
			                </td>
		                <td>
			                <div class="d-flex align-items-center gap-2">
				                <div class="progress flex-grow-1" style="height: 25px; font-size: 0.65rem;">
                                    @if (r.TotalStake == 0)
                                    {
	                                    <div class="progress-bar projected-home text-center" style="width:@r.HomePct%">@(r.HomePct > 5 ? $"{r.HomePct}%" : "")</div>
                                        <div class="progress-bar projected-draw text-center" style="width:@r.DrawPct%">@(r.DrawPct > 5 ? $"{r.DrawPct}%" : "")</div>
                                        <div class="progress-bar projected-away text-center" style="width:@r.AwayPct%">@(r.AwayPct > 5 ? $"{r.AwayPct}%" : "")</div>
                                    }
                                    else
                                    {
	                                    <div class="progress-bar progress-home text-center" style="width:@r.HomePct%">@(r.HomePct > 5 ? $"{r.HomePct}%" : "")</div>
	                                    <div class="progress-bar progress-draw text-center" style="width:@r.DrawPct%">@(r.DrawPct > 5 ? $"{r.DrawPct}%" : "")</div>
	                                    <div class="progress-bar progress-away text-center" style="width:@r.AwayPct%">@(r.AwayPct > 5 ? $"{r.AwayPct}%" : "")</div>
                                    }
					              
				                </div>
			                </div>
		                </td>
	                </tr>
                }
                </tbody>

                <tfoot>
                    <tr>
                        <td colspan="5">
                            @{
                                var p = Model.Page;
                                var total = Model.TotalPages;
                                string Link(int i) => Url.Action("EventsSpread", "AdminInsights", new { area = "Admin", page = i })!;
                            }
                            <ul class="pagination pagination-ivm mb-0 d-flex justify-content-center">
                                <li class="page-item @(p == 1 ? "disabled" : null)">
                                    <a class="page-link" href="@(p == 1 ? "#" : Link(1))">&laquo;</a>
                                </li>
                                <li class="page-item @(p == 1 ? "disabled" : null)">
                                    <a class="page-link" href="@(p == 1 ? "#" : Link(p - 1))">&lsaquo;</a>
                                </li>
                                @for (var i = Math.Max(1, p - 3); i <= Math.Min(total, p + 3); i++)
                                {
                                    <li class="page-item @(i == p ? "active" : null)">
                                        <a class="page-link" href="@Link(i)">@i</a>
                                    </li>
                                }
                                <li class="page-item @(p == total ? "disabled" : null)">
                                    <a class="page-link" href="@(p == total ? "#" : Link(p + 1))">&rsaquo;</a>
                                </li>
                                <li class="page-item @(p == total ? "disabled" : null)">
                                    <a class="page-link" href="@(p == total ? "#" : Link(total))">&raquo;</a>
                                </li>
                            </ul>
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>
    }
</div>

									
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>

<script>
    (function(){
      const hubUrl = "/hubs/admin-insights";

      const connection = new signalR.HubConnectionBuilder()
        .withUrl(hubUrl)
        .withAutomaticReconnect()
        .build();

      function rowFor(eventId) {
        return document.querySelector(`tr[data-event-id="${eventId}"]`);
      }

      function setPctBar(el, pct) {
        if (!el) return;
        const v = Number(pct) || 0;
        el.style.width = v + "%";

        el.textContent = v > 5 ? (v.toFixed(2) + "%") : "";
      }

        function setTotalStake(row, totalStake) {
          const cell = row.querySelector('[data-role="total-stake"]');
          if (!cell) return;


          cell.textContent = `€${Number(totalStake).toFixed(2)}`;
          cell.classList.toggle("text-danger", (totalStake || 0) <= 0);
          cell.classList.toggle("text-dark", (totalStake || 0) > 0);
        }

        function setTotalCell(row, total) {
          const cell = row.querySelector('[data-role="total-bets"]');
          if (!cell) return;
          cell.textContent = total;
          cell.classList.toggle("text-danger", total == 0);
          cell.classList.toggle("text-dark",   total != 0);
        }

      connection.on("BetMixUpdated", function (m) {
        const row = rowFor(m.eventId);
        if (!row) return;

        setPctBar(row.querySelector(".progress-home"), m.homePct);
        setPctBar(row.querySelector(".progress-draw"), m.drawPct);
        setPctBar(row.querySelector(".progress-away"), m.awayPct);
        setTotalCell(row, m.totalBets);
        setTotalStake(row, m.totalStake);

      });

      connection.start().then(function(){

        document.querySelectorAll("tr[data-event-id]").forEach(tr => {
          const id = tr.getAttribute("data-event-id");
          if (id) connection.invoke("JoinEvent", id);
        });
      }).catch(err => console.error("[AdminInsightsHub] connect error", err));


      window.addEventListener("beforeunload", function(){
        document.querySelectorAll("tr[data-event-id]").forEach(tr => {
          const id = tr.getAttribute("data-event-id");
          if (id) connection.invoke("LeaveEvent", id);
        });
      });
    })();
</script>