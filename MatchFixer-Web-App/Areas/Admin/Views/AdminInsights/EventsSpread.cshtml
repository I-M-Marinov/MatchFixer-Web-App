@using MatchFixer_Web_App.Areas.Admin.ViewModels.Events
@model PaginatedEventList<EventBetStatsRow>
@{
    Layout = "/Areas/Admin/Views/Shared/_Layout.Admin.cshtml";
    ViewData["Title"] = "Events — Bet Spread";

    var leagueLogos = new Dictionary<string, int>
    {
	    ["Premier League"] = 39,
	    ["Parva Liga"] = 172,
	    ["Bundesliga"] = 78,
	    ["La Liga"] = 140,
	    ["Eredivisie"] = 88,
	    ["Ligue 1"] = 61,
	    ["Serie A"] = 135,
	    ["Liga Portugal"] = 94,
	    ["Swiss League"] = 207,
	    ["Polish League Ekstraklasa"] = 106
    };

}

<div class="background-profile"></div>


<div class="card events-spread-card p-3" style="background-color: rgba(0, 0, 0, 0.3); padding: 1.5em 2em; border-radius: 0.35em; z-index: 2;">
	<h3 class="h5 mb-3 text-center text-black">Upcoming Events — Bet Distribution</h3>

	<div id="leagueFilterPills" class="league-pills">
		<button class="league-pill active" data-league="all" title="All leagues">
			<i class="bi bi-globe"></i>
		</button>
	</div>
	
	<div id="competitionFilterBubbles"
	     class="d-flex justify-content-center align-items-center gap-2 mt-1 mb-2">
	</div>
	<div class="table-responsive admin-bets-spread-table">
        <table class="table align-middle">
            <thead>
                <tr>
					<th class="text-center">Event</th>
                    <th class="league-name">League</th>
                    <th class="sortable" data-sort="Kickoff">Kick Off</th>
                    <th class="sortable" data-sort="TotalStake">Total Stake</th>
                    <th class="sortable" data-sort="TotalBets">Total Bets</th>
                    <th class="text-center" style="min-width:220px">
                        <span class="progress-home badge"> Home </span>
                        |
                        <span class="progress-draw badge"> Draw </span>
                        |
                        <span class="progress-away badge"> Away </span>
                    </th>
                </tr>
            </thead>
            <tbody>
            @if (Model.Items.Any())
            {
	            @await Html.PartialAsync("_EventsSpreadRows", Model.Items)
            }
            else
            {
	            <tr >
		            <td colspan = "6" class ="text-center py-4 text-muted fw-semibold" >
			            No upcoming events for this
			            league.
		            </td >
	            </tr>
            }
            </tbody>

            <tfoot>
            <tr>
                <td colspan="6">
	                @{
		                var p = Model.Page;
		                var total = Model.TotalPages;
		                string Link(int i) => Url.Action(
			                "EventsSpread",
			                "AdminInsights",
			                new {
				                area = "Admin",
				                page = i,
				                sort = Context.Request.Query["sort"],
				                desc = Context.Request.Query["desc"],
				                league = Context.Request.Query["league"],
				                competition = Context.Request.Query["competition"]
			                }
		                )!;
	                }
	                <ul class="pagination pagination-ivm mb-0 d-flex justify-content-center">
		                <li class="page-item @(p == 1 ? "disabled" : null)">
			                <a class="page-link" href="@(p == 1 ? "#" : Link(1))">&laquo;</a>
		                </li>
		                <li class="page-item @(p == 1 ? "disabled" : null)">
			                <a class="page-link" href="@(p == 1 ? "#" : Link(p - 1))">&lsaquo;</a>
		                </li>
		                @for (var i = Math.Max(1, p - 3); i <= Math.Min(total, p + 3); i++)
		                {
			                <li class="page-item @(i == p ? "active" : null)">
				                <a class="page-link" href="@Link(i)">@i</a>
			                </li>
		                }
		                <li class="page-item @(p == total ? "disabled" : null)">
			                <a class="page-link" href="@(p == total ? "#" : Link(p + 1))">&rsaquo;</a>
		                </li>
		                <li class="page-item @(p == total ? "disabled" : null)">
			                <a class="page-link" href="@(p == total ? "#" : Link(total))">&raquo;</a>
		                </li>
	                </ul>
                </td>
            </tr>
            <div class="odds-color-map">
                <span class="me-2 text-primary" style="font-size: 0.65em;">
	                odds: 
                </span> 
                <span class="projected-home badge"> Home </span>
                |
                <span class="projected-draw badge"> Draw </span>
                |
                <span class="projected-away badge"> Away </span>
            </div>
            </tfoot>
        </table>
    </div>
</div>

									
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>

<script>

const leagueLogoMap = @Html.Raw(
	                      System.Text.Json.JsonSerializer.Serialize(leagueLogos ?? new Dictionary<string,int>())
                      );
    (function(){
      const hubUrl = "/hubs/admin-insights";
	 


      const connection = new signalR.HubConnectionBuilder()
        .withUrl(hubUrl)
        .withAutomaticReconnect()
        .build();

	  window.adminInsightsConnection = connection;

      function rowFor(eventId) {
        return document.querySelector(`tr[data-event-id="${eventId}"]`);
      }

      function setPctBar(el, pct) {
        if (!el) return;
        const v = Number(pct) || 0;
        el.style.width = v + "%";

        el.textContent = v > 5 ? (v.toFixed(2) + "%") : "";
      }

        function setTotalStake(row, totalStake) {
          const cell = row.querySelector('[data-role="total-stake"]');
          if (!cell) return;


          cell.textContent = `€${Number(totalStake).toFixed(2)}`;
          cell.classList.toggle("text-danger", (totalStake || 0) <= 0);
          cell.classList.toggle("text-dark", (totalStake || 0) > 0);
        }

        function setTotalCell(row, total) {
          const cell = row.querySelector('[data-role="total-bets"]');
          if (!cell) return;
          cell.textContent = total;
          cell.classList.toggle("text-danger", total == 0);
          cell.classList.toggle("text-dark",   total != 0);
        }

      connection.on("BetMixUpdated", function (m) {
        const row = rowFor(m.eventId);
        if (!row) return;

        setPctBar(row.querySelector(".progress-home"), m.homePct);
        setPctBar(row.querySelector(".progress-draw"), m.drawPct);
        setPctBar(row.querySelector(".progress-away"), m.awayPct);
        setTotalCell(row, m.totalBets);
        setTotalStake(row, m.totalStake);

      });

      connection.start().then(function(){

        document.querySelectorAll("tr[data-event-id]").forEach(tr => {
          const id = tr.getAttribute("data-event-id");
          if (id) connection.invoke("JoinEvent", id);
        });
      }).catch(err => console.error("[AdminInsightsHub] connect error", err));


      window.addEventListener("beforeunload", function(){
        document.querySelectorAll("tr[data-event-id]").forEach(tr => {
          const id = tr.getAttribute("data-event-id");
          if (id) connection.invoke("LeaveEvent", id);
        });
      });
    })();

	document.addEventListener("DOMContentLoaded", () => {

		const pillContainer = document.getElementById("leagueFilterPills");
		if (!pillContainer) return;

		const params = new URLSearchParams(window.location.search);
		const selectedLeague = params.get("league");

		/* -----------------------------
		   CREATE "ALL" BUTTON
		-------------------------------- */
		const allBtn = document.createElement("button");
		allBtn.className = "league-filter-pill";
		allBtn.dataset.league = "all";
		allBtn.title = "All leagues";
		allBtn.innerHTML = `<i class="bi bi-globe"></i>`;

		if (!selectedLeague) {
			allBtn.classList.add("active");
		}

		pillContainer.appendChild(allBtn);

		/* -----------------------------
		   CREATE LEAGUE PILLS
		-------------------------------- */
		Object.entries(leagueLogoMap).forEach(([league, leagueId]) => {

			const btn = document.createElement("button");
			btn.className = "league-filter-pill";
			btn.dataset.league = league;
			btn.title = league;

			if (selectedLeague === league) {
				btn.classList.add("active");
			}

			const img = document.createElement("img");
			img.src = `https://media.api-sports.io/football/leagues/${leagueId}.png`;
			img.alt = league;

			btn.appendChild(img);
			pillContainer.appendChild(btn);
		});

		/* -----------------------------
		   NAVIGATION LOGIC
		-------------------------------- */
		pillContainer.addEventListener("click", e => {
			const btn = e.target.closest(".league-filter-pill");
			if (!btn) return;

			const league = btn.dataset.league;
			const url = new URL(window.location.href);

			//  clear competition when league changes
			url.searchParams.delete("competition");

			if (league === "all") {
				url.searchParams.delete("league");
			} else {
				url.searchParams.set("league", league);
			}

			url.searchParams.set("page", 1);
			window.location.href = url.toString();
		});



		function applyLeagueBadges() {
			const leagueCounts = getLeagueCounts();
			const totalCount = getTotalCount();

			document.querySelectorAll(".league-filter-pill").forEach(btn => {
				const league = btn.dataset.league;

				btn.querySelector(".league-count-badge")?.remove();

				const count =
					league === "all"
						? getGlobalEventTotal()
						: (leagueCounts[league] ?? 0);

				const badge = document.createElement("span");
				badge.className = "league-count-badge";
				badge.textContent = count;

				if (count === 0) {
					badge.classList.add("zero");
				}

				btn.appendChild(badge);	
			});
		}

		applyLeagueBadges();

	});

		function getLeagueCounts() {
			const el = document.getElementById("league-counts-data");
			return el ? JSON.parse(el.textContent) : {};
		}

		function getCompetitionCounts() {
			const el = document.getElementById("competition-counts-data");
			return el ? JSON.parse(el.textContent) : {};
		}

		function getTotalCount() {
			const el = document.getElementById("league-total-count");
			return el ? Number(el.textContent) : 0;
		}

	document.addEventListener("DOMContentLoaded", () => {

		const table = document.querySelector(".admin-bets-spread-table table");
		if (!table) return;

		const tbody = table.querySelector("tbody");
		const headers = table.querySelectorAll("th.sortable");

		let sort = "TotalBets";
		let desc = true;
		let page = 1;

		headers.forEach(th => {
		th.style.cursor = "pointer";

			th.addEventListener("click", async () => {
				const key = th.dataset.sort;
				if (!key) return;

				desc = (sort === key) ? !desc : false;
				sort = key;
				page = 1;

				const url = new URL("/Admin/AdminInsights/EventsSpreadRows", window.location.origin);
				url.searchParams.set("sort", sort);
				url.searchParams.set("desc", desc);
				url.searchParams.set("page", page);

				const params = new URLSearchParams(window.location.search);

				const league = params.get("league");
				const competition = params.get("competition");

				if (league) url.searchParams.set("league", league);
				if (competition) url.searchParams.set("competition", competition);


				const html = await fetch(url).then(r => r.text());
				tbody.innerHTML = html;

				document.querySelectorAll("tr[data-event-id]").forEach(tr => {
				const id = tr.dataset.eventId;
				if (id && window.adminInsightsConnection) {
					window.adminInsightsConnection.invoke("JoinEvent", id);
				}
				});
			});
		});
	});

	function getCompetitionIcon(name) {
		switch (name) {
			case "UEFA Champions League":
				return "/images/live-events/champions-league.png";
			case "UEFA Europa League":
				return "/images/live-events/europa-league.png";
			case "UEFA Europa Conference League":
				return "/images/live-events/conference-league.png";
			default:
				return "/images/live-events/competition.png";
		}
	}

	function getCompetitionClass(name) {
		switch (name) {
			case "UEFA Champions League":
				return "bubble-champions";
			case "UEFA Europa League":
				return "bubble-europa";
			case "UEFA Europa Conference League":
				return "bubble-conference";
			default:
				return "bubble-generic";
		}
	}

	function getCompetitionCounts() {
	  const el = document.getElementById("competition-counts-data");
	  return el ? JSON.parse(el.textContent) : {};
	}

	function renderAdminCompetitionBubbles() {
		const container = document.getElementById("competitionFilterBubbles");
		if (!container) return;

		container.innerHTML = "";

		const counts = getCompetitionCounts();

		const competitionPriority = [
			"UEFA Champions League",
			"UEFA Europa League",
			"UEFA Europa Conference League"
		];

		competitionPriority.forEach(name => {
			const count = counts[name] ?? 0;

			const wrapper = document.createElement("div");
			wrapper.className = "competition-bubble-wrapper";
			wrapper.dataset.competition = name;

			if (count === 0) {
				wrapper.classList.add("disabled");
				wrapper.title = "No upcoming matches";
				wrapper.setAttribute("aria-disabled", "true");
			}

			const bubble = document.createElement("div");
			bubble.className = `competition-bubble ${getCompetitionClass(name)}`;

			const img = document.createElement("img");
			img.src = getCompetitionIcon(name);
			img.alt = name;

			// badge
			const badge = document.createElement("span");
			badge.className = "competition-count-badge";
			badge.textContent = count;

			bubble.appendChild(img);
			wrapper.appendChild(bubble);
			wrapper.appendChild(badge);
			container.appendChild(wrapper);
		});
	}




	document.addEventListener("DOMContentLoaded", () => {
		renderAdminCompetitionBubbles();
	});

	document.addEventListener("click", e => {
		const bubble = e.target.closest(".competition-bubble-wrapper");
		if (!bubble || bubble.classList.contains("disabled")) return;

		const competition = bubble.dataset.competition;
		const url = new URL(window.location.href);

		// competitions are GLOBAL → clear league
		url.searchParams.delete("league");

		// reset paging + replace competition
		url.searchParams.delete("page");
		url.searchParams.delete("competition");

		url.searchParams.set("competition", competition);
		url.searchParams.set("page", 1);

		window.location.href = url.toString();
	});


	function getGlobalEventTotal() {
		const leagues = getLeagueCounts();
		const competitions = getCompetitionCounts();

		const leagueTotal = Object.values(leagues).reduce((a, b) => a + b, 0);
		const competitionTotal = Object.values(competitions).reduce((a, b) => a + b, 0);

		return leagueTotal + competitionTotal;
	}

</script>

<script id="league-counts-data" type="application/json">
	@Json.Serialize(Model.LeagueEventCounts)
</script>

<script id="competition-counts-data" type="application/json">
	@Json.Serialize(Model.CompetitionCounts)
</script>

<script id="league-total-count" type="application/json">
	@Json.Serialize(Model.LeagueEventCounts.Values.Sum())
</script>
