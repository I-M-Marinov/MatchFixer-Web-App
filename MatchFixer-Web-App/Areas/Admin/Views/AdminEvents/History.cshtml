@model List<MatchFixer_Web_App.Areas.Admin.ViewModels.Events.AdminEventOverviewDto>
@{
	Layout = "/Areas/Admin/Views/Shared/_Layout.Admin.cshtml";
	ViewData["Title"] = "Events History";

	var totalProfit = Model.Sum(m => m.Profit);
	var totalLoss = Model.Where(m => m.Profit < 0).Sum(m => m.Profit);
	var totalPositive = Model.Where(m => m.Profit > 0).Sum(m => m.Profit);
	var totalUserWinnings = Model.Sum(m => m.TotalPayout);   // sum of all payouts to players

	var leagueStats = Model
		.GroupBy(m => m.LeagueName)
		.Select(g => new
		{
			League = g.Key,
			TotalProfit = g.Sum(x => x.Profit),
			EventCount = g.Count()
		})
		.OrderByDescending(x => x.TotalProfit)
		.ToList();


	var leagueLogos = new Dictionary<string, int>
	{
		["Premier League"] = 39,
		["Parva Liga"] = 242,
		["Bundesliga"] = 78,
		["La Liga"] = 140,
		["Eredivisie"] = 88,
		["Ligue 1"] = 61,
		["Serie A"] = 135,
		["Liga Portugal"] = 94,
		["Swiss League"] = 207,
		["Polish League Ekstraklasa"] = 106
	};
}

<h2 class="mb-4 match-events-history-header">Match Events History</h2>

<div class="accordion mb-4" id="dashboardAccordion">

	<!-- COMPANY PERFORMANCE -->
	<div class="accordion-item">
		<h2 class="accordion-header" id="headingPerf">
			<button class="accordion-button" type="button" data-bs-toggle="collapse"
					data-bs-target="#collapsePerf" aria-expanded="true">
				Company Performance Overview
			</button>
		</h2>

		<div id="collapsePerf" class="accordion-collapse collapse show">
			<div class="accordion-body">

				<div class="row mb-4">

					<!-- Total Net Profit -->
					<div class="col-lg-4 col-md-6 col-12">
						<div class="card shadow-sm border-0 event-history-card" style="border-left: 6px solid #28a745;">
							<div class="card-body d-flex align-items-center gap-3 justify-content-center">
								<i class="bi bi-graph-up text-success" style="font-size: 2rem;"></i>
								<div>
									<h6 class="text-muted mb-1">Total Net Profit</h6>
									<h4 class="fw-bold text-success text-center">€@totalProfit.ToString("F2")</h4>
								</div>
							</div>
						</div>
					</div>

					<!-- Total Loss -->
					<div class="col-lg-4 col-md-6 col-12">
						<div class="card shadow-sm border-0 event-history-card" style="border-left: 6px solid #dc3545;">
							<div class="card-body d-flex align-items-center gap-3 justify-content-center">
								<i class="bi bi-graph-down text-danger" style="font-size: 2rem;"></i>
								<div>
									<h6 class="text-muted mb-1">Total Loss</h6>
									<h4 class="fw-bold text-danger text-center">€@totalLoss.ToString("F2")</h4>
								</div>
							</div>
						</div>
					</div>

					<!-- Total Winning Events -->
					<div class="col-lg-4 col-md-6 col-12">
						<div class="card shadow-sm border-0 event-history-card" style="border-left: 6px solid #0d6efd;">
							<div class="card-body d-flex align-items-center gap-3 justify-content-center">
								<i class="bi bi-cash-coin text-primary" style="font-size: 2rem;"></i>
								<div>
									<h6 class="text-muted mb-1">Total Winning Events</h6>
									<h4 class="fw-bold text-primary text-center">€@totalPositive.ToString("F2")</h4>
								</div>
							</div>
						</div>
					</div>
					
					<!-- Total User Winnings -->
					
					<div class="col-12 d-flex justify-content-center mt-2">
						<div class="card shadow-sm border-0 event-history-card" style="border-left: 6px solid #6f42c1; width: 350px;">
							<div class="card-body d-flex align-items-center gap-3 justify-content-center">
								<i class="bi bi-gift text-purple" style="font-size: 2rem; color:#6f42c1;"></i>
								<div>
									<h6 class="text-muted mb-1">Total User Winnings</h6>
									<h4 class="fw-bold text-center" style="color:#6f42c1">€@totalUserWinnings.ToString("F2")</h4>
								</div>
							</div>
						</div>
					</div>

				</div>

			</div>
		</div>

	</div>


	<!-- PROFIT BY LEAGUE -->
	<div class="accordion-item">
		<h2 class="accordion-header" id="headingLeague">
			<button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
					data-bs-target="#collapseLeague">
				Profit by League
			</button>
		</h2>

		<div id="collapseLeague" class="accordion-collapse collapse">
			<div class="accordion-body">

				@if (leagueStats.Any())
				{
					<div class="row g-3 mb-4">
						@foreach (var league in leagueStats)
						{
							var color = league.TotalProfit > 0 ? "text-success"
							: league.TotalProfit < 0 ? "text-danger"
							: "text-warning";

							var borderColor = league.TotalProfit > 0 ? "#198754"
							: league.TotalProfit < 0 ? "#dc3545"
							: "#ffc107";

							<div class="col-md-4">
								<div class="card shadow-sm border-0" style="border-left: 6px solid @borderColor;">

									<div class="card-body text-center">

										<!-- League Logo -->
										@{
											int logoId = leagueLogos.ContainsKey(league.League) ? leagueLogos[league.League] : 39;
											string logoUrl = $"https://media.api-sports.io/football/leagues/{logoId}.png";
										}

										<img src="@logoUrl"
										     alt="@league.League logo"
										     class="img-fluid mb-2"
										     style="height:40px; width:auto; object-fit:contain;" />

										<!-- League name -->
										<h6 class="mb-1">@league.League</h6>

										<!-- Profit -->
										<div class="fw-bold @color">
											€@league.TotalProfit.ToString("F2")
										</div>

										<!-- Event count -->
										<small class="text-muted">@league.EventCount events</small>

									</div>

								</div>
							</div>

						}
					</div>
				}
				else
				{
					<p class="text-muted fst-italic">No league data available.</p>
				}

			</div>
		</div>
	</div>
</div>

<div class="background-profile"></div>

<form method="get" class="row g-3 mb-4">

	<div class="col-md-3">
		<label class="form-label">From Date</label>
		<input type="date" name="FromDate" class="form-control" />
	</div>

	<div class="col-md-3">
		<label class="form-label">To Date</label>
		<input type="date" name="ToDate" class="form-control" />
	</div>

	<div class="col-md-3">
		<label class="form-label">League</label>
		<input type="text" name="League" class="form-control" placeholder="Premier League" />
	</div>

	<div class="col-md-3 d-flex align-items-end">
		<button class="btn btn-primary w-100">Filter</button>
	</div>
</form>

<table class="table table-bordered table-hover">
	<thead class="table-light">
	<tr>
		<th>Match</th>
		<th>Date</th>
		<th>Result</th>
		<th>Bets</th>
		<th>Stake</th>
		<th>Payout</th>
		<th>Profit</th>
		<th></th>
	</tr>
	</thead>

	<tbody>
	@foreach (var e in Model)
	{
		<tr>
			<td>@e.MatchName</td>
			<td>@e.MatchDate.ToString("g")</td>
			<td>
				@if (e.IsCancelled)
				{
					<span class="badge bg-secondary">Cancelled</span>
				}
				else
				{
					<span>@e.HomeScore - @e.AwayScore</span>
				}
			</td>
			<td>@e.TotalBets</td>
			<td class="fw-bold @(
               e.TotalStake > 0 
                   ? "text-success" 
                   : e.TotalStake == 0 
	                   ? "text-warning" 
	                   : "text-danger"
               )">				
				€@e.TotalStake.ToString("F2")
			</td>
			<td class="fw-bold @(e.TotalPayout >= 0 ? "text-success" : "text-danger")">
				€@e.TotalPayout.ToString("F2")
			</td>
			<td class="fw-bold @(e.Profit >= 0 ? "text-success" : "text-danger")">
				€@e.Profit.ToString("F2")
			</td>
			<td>
				<button class="btn btn-sm btn-outline-primary"
				        data-bs-toggle="collapse"
				        data-bs-target="#event-@e.EventId">
					Details
				</button>
			</td>
		</tr>

		<tr class="collapse" id="event-@e.EventId">
			<td colspan="8">
				<div class="p-3">

					@if (e.Bets.Any())
					{
						@await Html.PartialAsync("_EventBetsPartial", e.Bets)
					}
					else
					{
						<p class="text-muted fst-italic">No bets were placed on this event.</p>
					}

					<hr />

					@if (e.Logs.Any())
					{
						@await Html.PartialAsync("_EventLogsPartial", e.Logs)
					}
					else
					{
						<p class="text-muted fst-italic">No changes were recorded for this event.</p>
					}

				</div>
			</td>
		</tr>
	}
	</tbody>
</table>

			
<script>
	const labels = @Html.Raw(Json.Serialize(Model.Select(m => m.MatchDate.ToString("yyyy-MM-dd"))));
	const profits = @Html.Raw(Json.Serialize(Model.Select(m => m.Profit)));

	new Chart(document.getElementById("profitChart"), {
		type: 'line',
		data: {
			labels: labels,
			datasets: [{
				label: 'Profit',
				data: profits,
				borderWidth: 2
			}]
		}
	});
</script>

<style>
    .event-details-box {
        background-color: tomato !important;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        padding: 1rem;
        margin-top: .5rem;
    }

	.match-events-history-header{
		margin-top: 3.75em;
		text-align: center;
	}

	.event-history-card{
		display: flex !important;
		align-items: center !important;
		gap: 6px !important;
		font-size: 0.65rem !important;
		font-weight: 600 !important;
		background-color: #000 !important;
		
	}

	.event-history-card h6{
		color: #fefefe !important;
	}
</style>