@model MatchFixer_Web_App.Areas.Admin.ViewModels.Bets.AdminUserBetsColumnsViewModel
@using MatchFixer.Common.Enums

@{
    Layout = "/Areas/Admin/Views/Shared/_Layout.Admin.cshtml";
    ViewData["Title"] = $"Bets · {Model.UserName ?? Model.Email}";

    string Money(decimal amount) => $"€{amount:0.00}";
    string MoneyOpt(decimal? amount) => amount.HasValue ? $"€{amount.Value:0.00}" : "-";
    string MoneySigned(decimal v) => $"{(v >= 0 ? "+" : "−")}€{Math.Abs(v):0.00}";


    string StatusBadge(BetStatus st) => st switch
    {
        BetStatus.Won => "badge bg-success",
        BetStatus.Lost => "badge bg-danger",
        BetStatus.Voided => "badge bg-secondary",
        BetStatus.Pending => "badge bg-warning text-dark",
        _ => "badge bg-light text-dark"
    };
}

@await Html.PartialAsync("_BackToUsersButton", "Users")


<div class="border-0 rounded-4 p-4 flex-fill">
@if (TempData["SuccessMessage"] != null)
{
	<div class="alert success-message" id="success-message">
		@TempData["SuccessMessage"]
	</div>
}

@if (TempData["ErrorMessage"] != null)
{
	<div class="alert error-message" id="error-message">
		@TempData["ErrorMessage"]
	</div>
}

</div>

<div class="background-profile"></div>

<div class="border-0 rounded-4 p-3">

	<div class="card shadow-sm border-0 rounded-4 admin-user-bets-card">

		<div class="card-body">

			<h5 class="card-title mb-3 text-center">
				Bets for @Model.UserName
			</h5>

			<!-- Quick totals -->
			<div class="row g-2 mb-3">
				<div class="col-6 col-md-3">
					<div class="p-3 rounded bg-light text-center">
						<div class="small text-muted">Pending</div>
						<div class="fs-5 fw-semibold">@Model.CountPending</div>
					</div>
				</div>
				<div class="col-6 col-md-3">
					<div class="p-3 rounded bg-light text-center">
						<div class="small text-muted">Won</div>
						<div class="fs-5 fw-semibold text-success">@Model.CountWon</div>
					</div>
				</div>
				<div class="col-6 col-md-3">
					<div class="p-3 rounded bg-light text-center">
						<div class="small text-muted">Lost / Voided</div>
						<div class="fs-5 fw-semibold text-danger">@Model.CountLostOrVoided</div>
					</div>
				</div>
				<div class="col-6 col-md-3">
					<div class="p-3 rounded bg-light text-center">
						<div class="small text-muted">Total stake</div>
						<div class="fs-5 fw-semibold">@Money(Model.TotalStake)</div>
					</div>
				</div>
				<div class="row g-2">
					<div class="col-12 col-sm-4">
						<div class="p-3 rounded bg-danger-subtle text-center">
							<div class="small text-muted">Total lost</div>
							<div class="fs-5 fw-semibold">@Money(Model.TotalLost)</div>
						</div>
					</div>

					<div class="col-12 col-sm-4">
						<div class="p-3 rounded @(Model.NetProfit >= 0 ? "bg-success-subtle" : "bg-danger-subtle") text-center">
							<div class="small text-muted">Total profit</div>
							<div class="fs-5 fw-semibold">@MoneySigned(Model.NetProfit)</div>
						</div>
					</div>

					<div class="col-12 col-sm-4">
						<div class="p-3 rounded bg-success-subtle text-center">
							<div class="small text-muted">Total returns (won)</div>
							<div class="fs-5 fw-semibold">@Money(Model.TotalReturns)</div>
						</div>
					</div>
				</div>

			</div>

			<!-- Three columns -->
			<div class="row g-3">
				<!-- Pending -->
				<div class="col-12 col-lg-4">
					<div class="card shadow-sm border-0 rounded-4 h-100">
						<div class="card-header d-flex justify-content-between align-items-center bg-warning-subtle">
							<span class="fw-semibold">Pending</span>
							<span class="badge text-bg-warning text-dark">@Model.CountPending</span>
						</div>
						<div class="card-body p-0 column-scroll">
							@if (Model.Pending.Count == 0)
							{
								<div class="text-muted small text-center py-3">No pending bets.</div>
							}
							else
							{
								<div class="table-responsive">
									<table class="table table-sm table-hover align-middle mb-0 bets-table">
										<thead class="table-light">
										<tr>
											<th>Created</th>
											<th class="text-end">Stake</th>
											<th class="text-end">Potential</th>
											<th class="text-center">Sel.</th>
										</tr>
										</thead>
										<tbody>
										@foreach (var r in Model.Pending)
										{
											<tr class="slip-row" data-slip-id="@r.Id">
												<td class="text-nowrap">@r.CreatedDisplay</td>
												<td class="text-end num">@Money(r.Stake)</td>
												<td class="text-end num">@MoneyOpt(r.PotentialReturn)</td>
												<td class="text-center">@r.Selections</td>
											</tr>
										}
										</tbody>
									</table>
								</div>
							}
						</div>
					</div>
				</div>

				<!-- Won -->
				<div class="col-12 col-lg-4">
					<div class="card shadow-sm border-0 rounded-4 h-100">
						<div class="card-header d-flex justify-content-between align-items-center bg-success-subtle">
							<span class="fw-semibold">Won</span>
							<span class="badge text-bg-success">@Model.CountWon</span>
						</div>
						<div class="card-body p-0 column-scroll">
							@if (Model.Won.Count == 0)
							{
								<div class="text-muted small text-center py-3">No winning bets yet.</div>
							}
							else
							{
								<div class="table-responsive">
									<table class="table table-sm table-hover align-middle mb-0 bets-table">
										<thead class="table-light">
										<tr>
											<th>Created</th>
											<th class="text-end">Stake</th>
											<th class="text-end">Return</th>
											<th class="text-center">Sel.</th>
										</tr>
										</thead>
										<tbody>
										@foreach (var r in Model.Won)
										{
											<tr class="slip-row" data-slip-id="@r.Id">
												<td class="text-nowrap">@r.CreatedDisplay</td>
												<td class="text-end num">@Money(r.Stake)</td>
												<td class="text-end num">@MoneyOpt(r.WinAmount)</td>
												<td class="text-center">@r.Selections</td>
											</tr>
										}
										</tbody>
									</table>
								</div>
							}
						</div>
					</div>
				</div>

				<!-- Lost / Voided -->
				<div class="col-12 col-lg-4">
					<div class="card shadow-sm border-0 rounded-4 h-100">
						<div class="card-header d-flex justify-content-between align-items-center bg-danger-subtle">
							<span class="fw-semibold">Lost / Voided</span>
							<span class="badge text-bg-danger">@Model.CountLostOrVoided</span>
						</div>
						<div class="card-body p-0 column-scroll">
							@if (Model.LostOrVoided.Count == 0)
							{
								<div class="text-muted small text-center py-3">Nothing here.</div>
							}
							else
							{
								<div class="table-responsive">
									<table class="table table-sm table-hover align-middle mb-0 bets-table">
										<thead class="table-light">
										<tr>
											<th>Created</th>
											<th class="text-end">Stake</th>
											<th class="text-center">Sel.</th>
											<th class="text-center">Status</th>
										</tr>
										</thead>
										<tbody>
										@foreach (var r in Model.LostOrVoided)
										{
											<tr class="slip-row" data-slip-id="@r.Id">
												<td class="text-nowrap">@r.CreatedDisplay</td>
												<td class="text-end num">@Money(r.Stake)</td>
												<td class="text-center">@r.Selections</td>
												<td class="text-center">
													<span class="@StatusBadge(r.SlipStatus)">@r.SlipStatus</span>
												</td>
											</tr>
										}
										</tbody>
									</table>
								</div>
							}
						</div>
					</div>
				</div>

			</div> <!-- /row -->
		</div>
	</div>
</div>

<!-- Slip Details Modal -->
<div class="modal fade" id="slipDetailsModal" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog modal-lg modal-dialog-scrollable modal-dialog-centered">
		<div class="modal-content rounded-4 shadow">
			<div class="modal-header">
				<h5 class="modal-title">Bet Slip Details</h5>
				<button type="button" class="btn-close-custom3" data-bs-dismiss="modal">&times;</button>
			</div>
			<div class="modal-body" id="slip-details-body">
				<div class="text-center text-muted py-3">
					Loading…
				</div>
			</div>
		</div>
	</div>
</div>

<style>
    /* Numbers align nicely */
    .bets-table .num {
        font-variant-numeric: tabular-nums;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    }

    /* Column independent scroll on desktop */
    @@media (min-width: 992px) {
        .column-scroll

    {
        max-height: calc(100vh - 22rem);
        overflow: auto;
    }

    }

    /* Tighter table text */
    .bets-table {
        font-size: .93rem;
    }
    @@media (max-width: 768px) {
        .bets-table

    {
        font-size: .9rem;
    }

    }
</style>

<script>
	document.addEventListener("DOMContentLoaded", () => {

		const rows = document.querySelectorAll(".slip-row");
		const modalEl = document.getElementById("slipDetailsModal");
		const modal = new bootstrap.Modal(modalEl);
		const body = document.getElementById("slip-details-body");

		rows.forEach(row => {
			row.style.cursor = "pointer";

			row.addEventListener("click", async () => {
				const slipId = row.dataset.slipId;

				modal.show();

				body.replaceChildren();

					const loaderWrapper = document.createElement("div");
					loaderWrapper.className = "d-flex flex-row justify-content-center align-items-center py-4 spinner-sequence";

					const green = document.createElement("div");
					green.className = "spinner-grow text-brand-green me-2";

					const blue = document.createElement("div");
					blue.className = "spinner-grow text-brand-blue";

					const green2 = document.createElement("div");
					green2.className = "spinner-grow text-brand-green me-2";  

					const blue2 = document.createElement("div");
					blue2.className = "spinner-grow text-brand-blue";

					loaderWrapper.appendChild(green);
					loaderWrapper.appendChild(blue);
					loaderWrapper.appendChild(green2);
					loaderWrapper.appendChild(blue2);

					body.appendChild(loaderWrapper);


				try {
					const response = await fetch(`/Admin/AdminUserBets/GetSlipDetails/${slipId}`);
					const html = await response.text();

					await new Promise(resolve => setTimeout(resolve, 1000));

					const parser = new DOMParser();
					const doc = parser.parseFromString(html, "text/html");
					const newChildren = [...doc.body.children];

					body.replaceChildren(...newChildren);
				}
				catch {
					body.replaceChildren();
					const error = document.createElement("div");
					error.className = "alert alert-danger";
					error.textContent = "Failed to load slip details.";
					body.appendChild(error);
				}
			});
		});
	});
</script>