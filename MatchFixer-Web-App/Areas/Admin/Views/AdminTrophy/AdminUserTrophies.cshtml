@using MatchFixer_Web_App.Areas.Admin.ViewModels.Trophy
@model List<AdminUserTrophyViewModel>

@{
	Layout = "/Areas/Admin/Views/Shared/_Layout.Admin.cshtml";
	ViewData["Title"] = "User Trophies";
}

<div class="back-to-users-btn-container">
	@await Html.PartialAsync("_BackToUsersButton", "Users")
</div>

<div class="background-profile"></div>

<h2 class="mb-3 admin-user-trophies-heading">🏆 User Trophies</h2>


@if (Model.Count > 1)
{
	<form asp-action="ReevaluateAll" method="post" class="mb-4 text-center">
		@Html.AntiForgeryToken()
		<button class="btn btn-warning">
			Re-evaluate all users
			
		</button>
	</form>
}


@if (Model.Count == 1)
{
	<div class="text-center mb-3">
		<a asp-action="AdminUserTrophies"
		   asp-controller="AdminTrophy"
		   class="btn btn-light btn-sm">
			Show All Users
			<i class="bi bi-file-person-fill"></i>
		</a>
	</div>
}

<div class="table-section d-flex flex-column mb-3" style="background-color: rgba(0, 0, 0, 0.3); padding: 2em; border-radius: 0.35em;">
	<table class="table table-bordered table-striped align-middle admin-user-trophies-table">
		<thead>
		<tr>
			<th>Image</th>
			<th>User</th>
			<th>Email</th>
			<th>Trophies</th>
			<th>Actions</th>
		</tr>
		</thead>
		<tbody>
		@foreach (var user in Model)
		{
			<tr>
				<td>
					<img src="@user.UserImageUrl"
					     id="admin-user-image-trophy-view"/>
				</td>
				<td>@user.FullName</td>
				<td>@user.Email</td>
				<td>
					@if (!user.Trophies.Any())
					{
						<span class="text-muted">No trophies</span>
					}
					else
					{
						var grouped = user.Trophies
							.GroupBy(t => t.Level)
							.OrderBy(g => g.Key);

						<div class="trophy-tier-grid">

							@foreach (var group in grouped)
							{
								<div class="trophy-tier-block tier-@group.Key.ToString().ToLower()">
									<div class="tier-title">
										@group.Key
									</div>

									<div class="tier-icons">
										@foreach (var t in group)
										{
											<img src="@t.IconUrl"
											     alt="@t.Name"
											     class="admin-trophy-icon"
											     data-bs-toggle="tooltip"
											     data-bs-html="true"
											     title="
                                     <strong>@t.Name</strong><br/>
                                     <small>@t.Description</small><br/>
                                     <hr class='my-1'/>
                                     <small><em>Awarded:</em> @t.AwardedOn.ToString("dd MMM yyyy")</small>
                                 " />
										}
									</div>
								</div>
							}

						</div>
					}
				</td>
				<td class="text-center">
					<form asp-action="ReevaluateUser" method="post">
						@Html.AntiForgeryToken()
						<input type="hidden" name="userId" value="@user.UserId"/>
						<button class="btn btn-sm btn-warning" id="re-evaluate-btn">
							Re-evaluate
						</button>
					</form>
				</td>
			</tr>
		}
		</tbody>
	</table>

</div>

<style>
	


</style>

<script>
	document.addEventListener("DOMContentLoaded", () => {
		document
			.querySelectorAll('[data-bs-toggle="tooltip"]')
			.forEach(el => new bootstrap.Tooltip(el));
	});
</script>

