@using MatchFixer.Core.ViewModels.LiveEvents
@model MatchEventFormModel

@{
	ViewData["Title"] = "Create and View Events";
}

<div class="game-background"></div>

<div class="border-0 rounded-4 p-2 flex-fill">
	@if (TempData["SuccessMessage"] != null)
	{
		<div class="alert success-message" id="success-message">
			@TempData["SuccessMessage"]
		</div>
	}

	@if (TempData["ErrorMessage"] != null)
	{
		<div class="alert error-message" id="error-message">
			@TempData["ErrorMessage"]
		</div>
	}

</div>

<ul class="nav nav-tabs mb-3 justify-content-center add-event-navigation-tabs" id="eventTabs" role="tablist">
	<li class="nav-item" role="presentation">
		<button class="nav-link active"
		        data-bs-toggle="tab"
		        data-bs-target="#manualTab"
		        type="button"
		        role="tab">
			Manual Event
		</button>
	</li>

	<li class="nav-item" role="presentation">
		<button class="nav-link"
		        data-bs-toggle="tab"
		        data-bs-target="#apiTab"
		        type="button"
		        role="tab">
			Upcoming Matches
		</button>
	</li>
</ul>


<div class="tab-content">

<div class="tab-pane fade show active" id="manualTab" role="tabpanel">
<div class="modal fade" id="createBoostModal" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<form id="createBoostForm">
				@Html.AntiForgeryToken()
				<div class="modal-header">
					<h5 class="modal-title">Create Odds Boost</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>

				<div class="modal-body">
					<input type="hidden" name="MatchEventId" id="MatchEventId" />

					<!-- Boost Value + Duration (same row) -->
					<div class="row">
						<div class="col-md-6 mb-3">
							<label class="form-label">Boost Value</label>
							<input type="number" step="0.01" class="form-control" name="BoostValue" required />
						</div>
						<div class="col-md-6 mb-3">
							<label class="form-label">Duration (minutes)</label>
							<input type="number" class="form-control" name="DurationMinutes" value="30" />
						</div>
					</div>

					<!-- Max Stake + Max Uses (same row) -->
					<div class="row">
						<div class="col-md-6 mb-3">
							<label class="form-label">Max Stake Per Bet</label>
							<input type="number" step="0.01" class="form-control" name="MaxStakePerBet" />
						</div>
						<div class="col-md-6 mb-3">
							<label class="form-label">Max Uses Per User</label>
							<input type="number" class="form-control" name="MaxUsesPerUser" />
						</div>
					</div>

					<!-- Start Time -->
					<div class="mb-3 d-flex align-items-center">
						<label class="form-label">Start Time (UTC)</label>
						<input type="datetime-local" class="form-control" name="StartUtc" />
						<small class="form-text text-muted">Leave empty to start immediately.</small>
					</div>

					<!-- Note -->
					<div class="mb-3 d-flex align-items-center">
						<label class="form-label">Note</label>
						<input type="text" class="form-control" name="Note" />
					</div>
				</div>

				<div class="modal-footer">
					<button type="submit" class="btn btn-primary">Create</button>
				</div>
			</form>
		</div>
	</div>
</div>


<div class="position-relative">
<div id="model-error-add-event" asp-validation-summary="ModelOnly"
     class="position-absolute start-50 translate-middle-x"
     style="top: -80px; white-space: nowrap; z-index: 1005;">
</div>

@* <div class="d-flex justify-content-center align-items-start flex-wrap gap-1 mt-1">*@				
<div class="events-layout">


<div class="add-match-event-container mt-4">
	<form id="team-selection-form" asp-action="AddMatchEvent" asp-controller="Event" method="post" class="needs-validation" novalidate>
		@Html.AntiForgeryToken()
		<div class="teams-information d-flex justify-content-center align-items-center gap-5 mb-3">
			<div class="col">
				<div class="text-center my-2">
					<img id="home-team-logo"
					     src="/images/add-match/question-mark.png"
					     alt="Home Team Logo"
					     class="adding-team-logo"
					     style="max-height: 75px; margin-bottom:1em;"/>
				</div>
				<select asp-for="HomeTeamId" id="home-team-select" class="form-control">
					<option value="">-- Select Home Team --</option>
					@foreach (var league in Model.TeamsByLeague)
					{
						<optgroup class="add-team-league-label" label="@league.Key">
							@foreach (var team in league.Value)
							{
								var logoUrl = team.Text.Split('|').ElementAtOrDefault(1);
								var teamName = team.Text.Split('|').FirstOrDefault();
								<option value="@team.Value" data-logo="@logoUrl">@teamName</option>
							}
						</optgroup>
					}
				</select>
				<span asp-validation-for="HomeTeamId" class="bg-info validation-add-event centered-validation"></span>
			</div>

			<div class="col">
				<div class="text-center my-2">
					<img id="away-team-logo"
					     src="/images/add-match/question-mark.png"
					     alt="Away Team Logo"
					     class="adding-team-logo"
					     style="max-height: 75px; margin-bottom:1em;"/>
				</div>
				<select asp-for="AwayTeamId" id="away-team-select" class="form-control">
					<option value="">-- Select Away Team --</option>
					@foreach (var league in Model.TeamsByLeague)
					{
						<optgroup class="add-team-league-label" label="@league.Key">
							@foreach (var team in league.Value)
							{
								var logoUrl = team.Text.Split('|').ElementAtOrDefault(1);
								var teamName = team.Text.Split('|').FirstOrDefault();
								<option value="@team.Value" data-logo="@logoUrl">@teamName</option>
							}
						</optgroup>
					}
				</select>
				<span asp-validation-for="AwayTeamId" class="bg-info validation-add-event centered-validation"></span>
			</div>
		</div>
		
		<div class="match-event-competiton mb-1 text-center">
			<label asp-for="CompetitionName" class="form-label">
				Competition
			</label>

			<select asp-for="CompetitionName"
			        asp-items="Model.AvailableCompetitions"
			        id="match-event-competition-select"
			        class="form-control">
			</select>
		</div>

		<div id="dateAndTime" class="mb-3">
			<label asp-for="MatchDate" class="form-label">Date and Time</label>
			<input asp-for="MatchDate" class="form-control" type="datetime-local" value="@Model.MatchDate.ToString("yyyy-MM-ddTHH:mm")"/>
			<span asp-validation-for="MatchDate" class="bg-info validation-add-event centered-validation"></span>
		</div>

		<div class="d-flex justify-content-center align-items-center row mb-3">
			<div class="home-odds col">
				<label asp-for="HomeOdds" class="form-label">Home Team Win</label>
				<input asp-for="HomeOdds" class="form-control"/>
				<span asp-validation-for="HomeOdds" class="bg-info validation-add-event centered-validation"></span>
			</div>
			<div class="draw-odds col">
				<label asp-for="DrawOdds" class="form-label">Draw</label>
				<input asp-for="DrawOdds" class="form-control"/>
				<span asp-validation-for="DrawOdds" class="bg-info validation-add-event centered-validation"></span>

			</div>
			<div class="away-odds col">
				<label asp-for="AwayOdds" class="form-label">Away Team Win</label>
				<input asp-for="AwayOdds" class="form-control"/>
				<span asp-validation-for="AwayOdds" class="bg-info validation-add-event centered-validation"></span>

			</div>
		</div>

		<span class="custom-add-match-tooltip-wrapper">
			<button type="submit" class="btn add-event-icon-container">
				<div class="text-center my-2">
					<img id="add-event-icon"
					     src="/images/add-match/add-event.png"
					     alt="Add Event"
					     style="max-height: 85px;"/>
				</div>
				<span class="custom-add-match-tooltip">Add this game to the Events Board</span>
			</button>


		</span>

	</form>
</div>


<div class="live-events-section mt-3 mx-auto" style="max-width: 1400px;">
	<h3 class="text-center mb-2">Current Live Events</h3>
	<ul class="nav nav-pills justify-content-center mb-3" id="eventDateTabs"></ul>

	@if (Model.CurrentEvents.Any())
	{
		<div class="table-responsive">

			<div class="live-events-table-wrapper">
				<table class="responsive-stack table table-bordered table-hover text-center shadow-sm rounded-3 table-sm align-middle"
				       id="live-events-table">
					<thead class="table-dark">
					<tr>
						<th>Status</th>
						<th>Date & Time (local)</th>
						<th>Home Team</th>
						<th>Away Team</th>
						<th>Boost</th>
						<th>Update</th>
					</tr>
					</thead>
					<tbody>
					@foreach (var ev in Model.CurrentEvents)
					{
						<tr class="@(ev.ApiFixtureId > 0 ? "api-imported-match" : "manually-added-match") @(ev.MatchStatus == "Started" ? "event-started-match" : "")"
						    data-date="@(ev.KickoffTime.HasValue 
							               ? ev.KickoffTime.Value.ToString("yyyy-MM-dd") 
							               : "tba")"
						    data-postponed="@ev.IsPostponed">
							<td>
								@if (ev.IsPostponed || !ev.KickoffTime.HasValue)
								{
									<span class="badge bg-secondary ms-1">
										<i class="bi bi-pause-circle-fill me-1"></i>
										Postponed
									</span>
								}
								else if (ev.MatchStatus != "Started" && ev.IsCancelled != true)
								{
									<form asp-action="PostponeMatchEvent"
									      asp-controller="Event"
									      method="post"
									      class="d-inline">
										@Html.AntiForgeryToken()
										<input type="hidden" name="id" value="@ev.Id" />

										<button type="submit"
										        class="btn btn-sm btn-secondary text-center"
										        onclick="return confirm('Are you sure you want to postpone this match?')"
												title="Postpone this match">
											<i class="bi bi-pause-circle"></i>
										</button>
									</form>
								}
								else if (ev.MatchStatus == "Started" && ev.IsCancelled != true)
								{
									<span class="badge ms-1">
										<i class="bi bi-play-circle-fill me-1"></i>
										Started
									</span>
								}

								@if (ev.ApiFixtureId != null && ev.MatchStatus != "Started" && ev.KickoffTime.HasValue)
								{
									<span class="badge bg-info ms-1">auto</span>
								}
								else if (ev.ApiFixtureId == null && ev.MatchStatus != "Started" && ev.KickoffTime.HasValue)
								{
									<span class="badge bg-manual ms-1">manual</span>
								}
							</td>

							<td>
								@if (ev.IsPostponed || !ev.KickoffTime.HasValue)
								{
									<span class="badge bg-secondary">TBA</span>
								}
								else
								{
									@ev.KickoffTime.Value.ToLocalTime().ToString("g")
								}							
							</td>

							<td class="team-cell">
								<div class="team-row home-team">
									<img src="@ev.HomeTeamLogoUrl"
									     alt="@ev.HomeTeam Logo"
									     class="team-logo" />
									<span class="team-name">@ev.HomeTeam</span>
								</div>

								<div class="team-row away-team d-md-none">
									<img src="@ev.AwayTeamLogoUrl"
									     alt="@ev.AwayTeam Logo"
									     class="team-logo" />
									<span class="team-name">@ev.AwayTeam</span>
								</div>
							</td>

							<td class="team-cell d-none d-md-table-cell">
								<div class="team-row away-team">
									<img src="@ev.AwayTeamLogoUrl"
									     alt="@ev.AwayTeam Logo"
									     class="team-logo" />
									<span class="team-name">@ev.AwayTeam</span>
								</div>
							</td>

							<td>
								@if (ev.BoostActive != null)
								{
									<div class="d-flex flex-column align-items-center gap-1">

										<button type="button"
										        class="btn btn-sm btn-outline-danger stop-boost-btn"
										        data-boost-id="@ev.BoostActive.Id">
											<i class="ri-stop-circle-line"></i>
											Stop
										</button>

										<span class="boost-countdown fw-bold"
										      data-boost-end="@ev.BoostActive.EndUtc.ToString("yyyy-MM-ddTHH:mm:ssZ")">
										</span>
									</div>
								}
								else
								{
									<span class="custom-tooltip-wrapper">
										@if (ev.MatchStatus == "Started" || ev.IsPostponed || !ev.KickoffTime.HasValue)
										{
											<button type="button" class="btn btn-sm btn-outline-danger create-boost-btn text-muted"
											        data-match-id="@ev.Id" disabled>
												<i class="ri-fire-fill"></i>
											</button>
											<span class="custom-tooltip text-bg-info">Cannot add a boost to this game right now !</span>
										}
										else
										{
											<button type="button" class="btn btn-sm btn-warning create-boost-btn"
											        data-bs-toggle="modal"
											        data-bs-target="#createBoostModal"
											        data-match-id="@ev.Id">
												<i class="ri-fire-fill"></i>
											</button>
											<span class="custom-tooltip text-bg-warning">Add an odds boost for this game</span>
										}
									</span>

								}
							</td>
							<td style="max-width: 350px;">
								<div class="d-flex justify-content-center align-items-center">

									<div class="d-flex flex-column gap-1">

										@{
											var isDisabled = (ev.MatchStatus == "Started" || ev.ActiveBoost != null || ev.IsPostponed) ? "disabled" : "";

										}


										<div class="d-flex gap-2">
											<input type="number" id="HomeOddsInput-@ev.Id" data-id="@ev.Id" step="0.01"
											       value="@ev.HomeWinOdds" class="form-control form-control-sm home-odds-style" style="width: 80px;" placeholder="Home" @isDisabled/>
											<input type="number" id="DrawOddsInput-@ev.Id" data-id="@ev.Id" step="0.01"
											       value="@ev.DrawOdds" class="form-control form-control-sm draw-odds-style" style="width: 80px;" placeholder="Draw" @isDisabled/>
											<input type="number" id="AwayOddsInput-@ev.Id" data-id="@ev.Id" step="0.01"
											       value="@ev.AwayWinOdds" class="form-control form-control-sm away-odds-style" style="width: 80px;" placeholder="Away" @isDisabled/>
										</div>

										<input type="datetime-local"
										       id="MatchDateInput-@ev.Id"
										       data-id="@ev.Id"
										       value="@(ev.KickoffTime.HasValue 
											              ? ev.KickoffTime.Value.ToString("yyyy-MM-ddTHH:mm") 
											              : "")"
										       class="form-control form-control-sm matchdate-style"
										       style="min-width: 240px;"
										       @isDisabled />

									</div>

									<div class="d-flex flex-column gap-1 align-items-end">
										@if (ev.MatchStatus != "Started")
										{
											<form asp-action="EditMatchEvent" asp-controller="Event" method="post" class="d-inline" id="editForm-@ev.Id">
												@Html.AntiForgeryToken()
												<input type="hidden" name="Id" value="@ev.Id"/>
												<input type="hidden" name="HomeOdds" id="HiddenHomeOdds-@ev.Id"/>
												<input type="hidden" name="DrawOdds" id="HiddenDrawOdds-@ev.Id"/>
												<input type="hidden" name="AwayOdds" id="HiddenAwayOdds-@ev.Id"/>
												<input type="hidden" name="MatchDate" id="HiddenMatchDate-@ev.Id"/>

												<span class="custom-save-remove-tooltip-wrapper">
													<button type="submit" class="btn btn-outline-success btn-sm update-event-btn">
														<div class="icon">
															<i class="bx bxs-save"></i>
														</div>
													</button>
													<span class="custom-save-remove-tooltip">Save the event</span>
												</span>
											</form>
										}

										@if (ev.IsCancelled != true)
										{
											<form asp-action="CancelMatchEvent" asp-controller="Event" method="post" class="d-inline">
												@Html.AntiForgeryToken()
												<input type="hidden" name="id" value="@ev.Id"/>
												<span class="custom-save-remove-tooltip-wrapper">
													<button type="button"
													        class="btn btn-outline-danger btn-sm update-event-btn"
													        data-bs-toggle="modal"
													        data-bs-target="#confirmCancelModal"
													        data-event-id="@ev.Id">
														<div class="icon">
															<i class="ri-delete-bin-2-fill"></i>
															<div class="label"></div>
														</div>
													</button>
													<span class="custom-save-remove-tooltip">Cancel the event</span>
												</span>

											</form>
										}
									</div>

								</div>
							</td>

						</tr>
					}
					</tbody>
				</table>
			</div>
		</div>
	}
	else
	{
		<div class="alert alert-info text-center">
			There are no live or started events available.
		</div>
	}

</div>
</div>

</div>


<div class="modal fade" id="confirmCancelModal" tabindex="-1" aria-labelledby="confirmCancelLabel" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered">
		<div class="modal-content border-danger">
			<div class="modal-header text-danger fw-bold">
				<h5 class="modal-title" id="confirmCancelLabel">
					<i class="bi bi-exclamation-triangle-fill me-2"></i>
					Confirm Cancellation
				</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body text-center">
				Are you sure you want to void this event?
			</div>
			<div class="modal-footer justify-content-center">
				<form id="cancelEventForm" asp-action="CancelMatchEvent" asp-controller="Event" method="post">
					@Html.AntiForgeryToken()
					<input type="hidden" name="id" id="cancelEventId" value="" />
					<button type="submit" class="btn btn-danger">Yes, Void</button>
				</form>
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No, Go Back</button>
			</div>
		</div>
	</div>
</div>
</div>

<div class="tab-pane fade" id="apiTab" role="tabpanel">
	<div class="card shadow-sm p-3 add-match-auto-card">

		<form id="addUpcomingForm" asp-action="AddUpcomingMatches" asp-controller="Event" method="post">
			@Html.AntiForgeryToken()
			<div class="row mb-3 align-items-end">
				<div class="col-md-4">
					<label class="form-label">League</label>
					<select id="apiLeagueSelect" class="form-select">
						<option value="">Select league</option>
						@foreach (var league in Model.ApiLeagues)
						{
							<option value="@league.ApiLeagueId">@league.Name</option>
						}
					</select>
				</div>

				<div class="col-md-3">
					<button type="button" id="loadUpcomingBtn" class="btn btn-primary">
						Load upcoming matches
					</button>
				</div>
			</div>

			<div class="table-responsive api-upcoming-matches-table">
				<table class="table table-sm table-hover align-middle text-center">
					<thead class="table-dark">
					<tr>
						<th>Add</th>
						<th>Status</th>
						<th>Date</th>
						<th>Home</th>
						<th>Away</th>
						<th>H</th>
						<th>D</th>
						<th>A</th>
					</tr>
					</thead>
					<tbody id="apiMatchesBody">
					<tr>
						<td colspan="7" class="text-muted">
							Select a league to load upcoming matches
						</td>
					</tr>
					</tbody>
				</table>
			</div>

			<button type="button"
			        class="btn btn-success"
			        id="reviewUpcomingBtn">
				Review & Add selected matches
			</button>

		</form>

	</div>
</div>

</div>
<div class="modal fade" id="reviewUpcomingModal" tabindex="-1">
	<div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
		<div class="modal-content">

			<div class="modal-header">
				<h5 class="modal-title">
					<i class="bi bi-clipboard-check me-2"></i>
					Review Upcoming Matches
				</h5>
				<button type="button" class="btn-close review-upcoming-matches-close-btn" data-bs-dismiss="modal"></button>
			</div>

			<div class="modal-body">

				<table class="table table-sm table-hover align-middle text-center">
					<thead class="table-dark">
					<tr>
						<th>Status</th>
						<th>Date</th>
						<th>Home</th>
						<th>Away</th>
						<th>H</th>
						<th>D</th>
						<th>A</th>
					</tr>
					</thead>
					<tbody id="reviewMatchesBody">
					
					</tbody>
				</table>

			</div>

			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
					Cancel
				</button>

				<button type="button"
				        class="btn btn-success"
				        id="confirmAddUpcoming">
					Confirm & Add Matches
				</button>
			</div>

		</div>
	</div>
</div>




@section Scripts {
	<partial name="_ValidationScriptsPartial" />

	<script>

		function logoChange(selectId, logoImgId, placeholder) {
			const select = document.getElementById(selectId);
			const logoImg = document.getElementById(logoImgId);

			select.addEventListener('change', function () {
				const selectedOption = select.options[select.selectedIndex];
				const logoUrl = selectedOption.getAttribute('data-logo');

				if (selectedOption.value === "" || !logoUrl) {
					logoImg.src = placeholder;
				} else {
					logoImg.src = logoUrl;
				}
			});
		}

		const placeholderImage = '/images/add-match/question-mark.png';

		logoChange('home-team-select', 'home-team-logo', placeholderImage);
		logoChange('away-team-select', 'away-team-logo', placeholderImage);

		document.addEventListener('DOMContentLoaded', function () {

			document.querySelectorAll("form[id^='editForm-']").forEach(form => {

				form.addEventListener('submit', function (e) {

					const id = form.querySelector("input[name='Id']").value;

					const homeVal = document.getElementById(`HomeOddsInput-${id}`).value;
					const drawVal = document.getElementById(`DrawOddsInput-${id}`).value;
					const awayVal = document.getElementById(`AwayOddsInput-${id}`).value;
					const dateVal = document.getElementById(`MatchDateInput-${id}`).value;

					document.getElementById(`HiddenHomeOdds-${id}`).value = homeVal;
					document.getElementById(`HiddenDrawOdds-${id}`).value = drawVal;
					document.getElementById(`HiddenAwayOdds-${id}`).value = awayVal;
					document.getElementById(`HiddenMatchDate-${id}`).value = dateVal;

				});
			});
		});



		document.addEventListener('DOMContentLoaded', function () {

			const confirmModal = document.getElementById('confirmCancelModal');

			confirmModal.addEventListener('show.bs.modal', function (event) {
				const button = event.relatedTarget;
				const eventId = button.getAttribute('data-event-id');
				document.getElementById('cancelEventId').value = eventId;
			});

		});

		document.addEventListener("DOMContentLoaded", () => {
			const form = document.getElementById("createBoostForm");
			const matchIdInput = document.getElementById("MatchEventId");

			// When modal is triggered, set the hidden field
			document.querySelectorAll(".create-boost-btn").forEach(btn => {
				btn.addEventListener("click", () => {
					const matchId = btn.getAttribute("data-match-id");
					matchIdInput.value = matchId;
				});
			});

			form.addEventListener("submit", async function (e) {
				e.preventDefault();

				const formData = new FormData(form);

				// Convert local datetime-local to UTC
				const startInput = form.querySelector("input[name='StartUtc']");
				if (startInput && startInput.value) {
					const localDate = new Date(startInput.value);
					formData.set("StartUtc", localDate.toISOString());
				}

				// Get anti-forgery token
				const tokenInput = form.querySelector("input[name='__RequestVerificationToken']");
				const token = tokenInput ? tokenInput.value : "";

				try {
					const response = await fetch("/Event/CreateOddsBoost", {
						method: "POST",
						body: formData,
						headers: {
							"RequestVerificationToken": token
						}
					});

					if (!response.ok) throw new Error(`HTTP error ${response.status}`);

					const result = await response.json();

					if (result.success) {
						alert("Promo created successfully!");
						location.reload();
					} else {
						alert("Error: " + (result.message || "Unknown error occurred."));
					}
				} catch (err) {
					console.error("Request failed", err);
					alert("Request failed: " + err.message);
				}
			});
		});

		document.addEventListener("DOMContentLoaded", () => {
			document.querySelectorAll(".boost-countdown").forEach(startBoostCountdown);
		});


		document.addEventListener("DOMContentLoaded", function () {
			const connection = new signalR.HubConnectionBuilder()
				.withUrl("/matchEventHub")
				.withAutomaticReconnect()
				.build();

			connection.start()
				.then(() => {
					console.log("SignalR connected");
					document.querySelectorAll('.event-card').forEach(card => {
						const matchId = card.dataset.matchId;
						console.log("Subscribing to match", matchId);
						connection.invoke("SubscribeToEvent", matchId)
							.then(() => console.log("Subscribed to", matchId))
							.catch(err => console.error(`Failed to subscribe to match ${matchId}:`, err.toString()));
					});
			})

			connection.on("MatchEventUpdated", function (update) {

				if (update.activeBoostId === null) {

					const row = document.querySelector(
						`#live-events-table tr[data-match-id="${update.matchEventId}"]`
					);
					if (!row) return;

					const boostCell = row.querySelector("td:nth-child(5)");
					if (!boostCell) return;

					boostCell.replaceChildren(
						renderCreateBoostButton(update.matchEventId)
					);

					return; 
				}


				const card = document.querySelector(`[data-match-id="${update.matchEventId}"]`);
				if (!card) return;

				const homeOddsElement = card.querySelector('tbody span[data-option="Home"]');
				const drawOddsElement = card.querySelector('tbody span[data-option="Draw"]');
				const awayOddsElement = card.querySelector('tbody span[data-option="Away"]');

				const homeHeader = card.querySelector('thead th[data-option="Home"]');
				const drawHeader = card.querySelector('thead th[data-option="Draw"]');
				const awayHeader = card.querySelector('thead th[data-option="Away"]');

				const hasBoost = update.activeBoostId != null;

				if (!hasBoost) {

						if (homeOddsElement && homeHeader) {
							homeHeader.dataset.odds = update.homeOdds;
							animateOddsChange(homeOddsElement, update.homeOdds, update.matchEventId, "Home", false);
						}

						if (drawOddsElement && drawHeader) {
							drawHeader.dataset.odds = update.drawOdds;
							animateOddsChange(drawOddsElement, update.drawOdds, update.matchEventId, "Draw", false);
						}

						if (awayOddsElement && awayHeader) {
							awayHeader.dataset.odds = update.awayOdds;
							animateOddsChange(awayOddsElement, update.awayOdds, update.matchEventId, "Away", false);
						}
				} else {
					animateOddsChange(homeOddsElement, update.effectiveHomeOdds, update.matchEventId, "Home", true);
					animateOddsChange(drawOddsElement, update.effectiveDrawOdds, update.matchEventId, "Draw", true);
					animateOddsChange(awayOddsElement, update.effectiveAwayOdds, update.matchEventId, "Away", true);

					if (homeHeader) homeHeader.dataset.odds = update.effectiveHomeOdds.toFixed(2);
					if (drawHeader) drawHeader.dataset.odds = update.effectiveDrawOdds.toFixed(2);
					if (awayHeader) awayHeader.dataset.odds = update.effectiveAwayOdds.toFixed(2);
				}
			});

		connection.on("BoostStarted", function(boostData) {

			const card = document.querySelector(`[data-match-id="${boostData.matchEventId}"]`) ||
			document.querySelector(`[data-match-id='${boostData.matchEventId.toString()}']`);

			if (!card) return;
			const oddsRow = card.querySelector(".tw-divide-y .tw-divide-gray-200");

			activateBoost(oddsRow, boostData);
			});

		});

		// Football API request from the Admin

		document.getElementById("loadUpcomingBtn").addEventListener("click", async () => {
			const leagueId = document.getElementById("apiLeagueSelect").value;
			if (!leagueId) {
				alert("Select a league first");
				return;
			}

			const res = await fetch(`/Event/UpcomingFromApi?leagueId=${leagueId}`);
			document.getElementById("apiMatchesBody").innerHTML = await res.text();
		});

				
		document.addEventListener("DOMContentLoaded", () => {
			const upcomingForm = document.getElementById("addUpcomingForm");

			if (upcomingForm) {
				upcomingForm.addEventListener("submit", function(e) {
					e.preventDefault();

					const checkedBoxes = document.querySelectorAll("#apiMatchesBody input[type=checkbox]:checked");

					if (checkedBoxes.length === 0) {
						alert("Select at least one match.");
						return;
					}

					document.querySelectorAll("#apiMatchesBody input[type=checkbox]:not(:checked)")
						.forEach(cb => cb.closest('tr').remove());

					const tbody = document.getElementById("apiMatchesBody");
					const rows = tbody.querySelectorAll("tr");

					rows.forEach((row, newIndex) => {
						// Only process inputs INSIDE the tbody rows, not the anti-forgery token
						row.querySelectorAll("input").forEach(input => {
							const name = input.getAttribute("name");
							if (name && name.startsWith("Selected[")) {  
								const newName = name.replace(/Selected\[\d+\]/, `Selected[${newIndex}]`);
								input.setAttribute("name", newName);
							}
						});
					});

					// Verify anti-forgery token exists before submitting
					const token = this.querySelector("input[name='__RequestVerificationToken']");
					if (!token) {
						console.error("Anti-forgery token missing!");
						alert("Security token missing. Please refresh the page.");
						return;
					}

					this.submit();
				});
			}
		});



		document.addEventListener("DOMContentLoaded", () => {
			const rows = [...document.querySelectorAll("#live-events-table tbody tr")];
			const tabs = document.getElementById("eventDateTabs");

			if (!rows.length) return;

			const uniqueDates = [
			  ...new Set(
				rows
				  .map(r => r.dataset.date)
				  .filter(d => d && d !== "tba")
			  )
			].slice(0, 5);

			const today = new Date();
			today.setHours(0,0,0,0);

			function labelFor(dateStr) {
				const d = new Date(dateStr + "T00:00:00");
				const diff = (d - today) / 86400000;

				if (diff === 0) return "Today";
				if (diff === 1) return "Tomorrow";

				return d.toLocaleDateString(undefined, {
					weekday: "short",
					day: "numeric",
					month: "short"
				});
			}

			function filter(date) {
				rows.forEach(r => {
					if (date === "all") {
						r.style.display = "";
					} else {
						r.style.display = r.dataset.date === date ? "" : "none";
					}
				});
			}

			const allLi = document.createElement("li");
				allLi.className = "nav-item";
				allLi.innerHTML = `
					<button class="nav-link active" data-date="all">
						All
					</button>
				`;

				tabs.appendChild(allLi);

			const postponedLi = document.createElement("li");
				postponedLi.className = "nav-item";
				postponedLi.innerHTML = `
				  <button class="nav-link" data-date="tba">
					Postponed
				  </button>
				`;

				tabs.appendChild(postponedLi);

			uniqueDates.forEach((date, i) => {
				const li = document.createElement("li");
				li.className = "nav-item";

				li.innerHTML = `
					<button class="nav-link"
							data-date="${date}">
						${labelFor(date)}
					</button>
				`;

				tabs.appendChild(li);
			});

			tabs.addEventListener("click", e => {
				if (!e.target.dataset.date) return;

				tabs.querySelectorAll(".nav-link").forEach(b => b.classList.remove("active"));
				e.target.classList.add("active");

				filter(e.target.dataset.date);
			});
		});


		document.addEventListener("DOMContentLoaded", function () {
			const tooltipTriggerList = [].slice.call(
				document.querySelectorAll('[data-bs-toggle="tooltip"]')
			);

			tooltipTriggerList.forEach(el => {
					new bootstrap.Tooltip(el);
			});
		});

		document.addEventListener("DOMContentLoaded", () => {

			const DEFAULT_ODDS = {
				home: 1.11,
				draw: 2.22,
				away: 3.33
			};

			const reviewBtn = document.getElementById("reviewUpcomingBtn");
			const modal = new bootstrap.Modal(document.getElementById("reviewUpcomingModal"));
			const body = document.getElementById("reviewMatchesBody");
			const form = document.getElementById("addUpcomingForm");
			const confirmBtn = document.getElementById("confirmAddUpcoming");

			reviewBtn.addEventListener("click", () => {

				const selectedRows = [
					...document.querySelectorAll("#apiMatchesBody tr")
				].filter(r => {
					const cb = r.querySelector("input[type=checkbox]");
					return cb && cb.checked && !cb.disabled;
				});

				if (!selectedRows.length) {
					alert("Select at least one match.");
					return;
				}

				body.innerHTML = "";

				selectedRows.forEach(row => {

					const clone = row.cloneNode(true);

					const firstTd = clone.querySelector("td");
					if (firstTd) {
						firstTd.remove();
					}
					clone.querySelectorAll("input[type='number']").forEach(input => {
						const td = input.closest("td");
						if (!td) return;

						const value = parseFloat(input.value);
						const colIndex = [...td.parentElement.children].indexOf(td);

						let pillClass = "pill-brand-blue";
						let isDefault = false;


						if (colIndex === 4) {
							isDefault = value === DEFAULT_ODDS.home;
							pillClass = isDefault ? "pill-brand-red" : "pill-brand-blue";
						}

						if (colIndex === 5) {
							isDefault = value === DEFAULT_ODDS.draw;
							pillClass = isDefault ? "pill-brand-red" : "pill-brand-yellow";
						}

						if (colIndex === 6) {
							isDefault = value === DEFAULT_ODDS.away;
							pillClass = isDefault ? "pill-brand-red" : "pill-brand-green";
						}

						td.innerHTML = `
							<span class="pill ${pillClass}"
								  ${isDefault ? `title="Default odds detected"` : ""}>
								${value.toFixed(2)}
							</span>
						`;

						if (isDefault) {
							td.closest("tr")?.classList.add("has-default-odds");
						}

						const hasDefaults =
							body.querySelectorAll("tr.has-default-odds").length > 0;

						if (hasDefaults) {
							confirmBtn.disabled = true;
							confirmBtn.innerHTML = `
								<i class="bi bi-exclamation-triangle-fill me-1"></i>
								Default odds detected
							`;
							confirmBtn.classList.remove("btn-success");
							confirmBtn.classList.add("btn-danger");
							confirmBtn.title = "Please adjust default odds (1.11 / 2.22 / 3.33) before importing.";
						} else {
							confirmBtn.disabled = false;
							confirmBtn.innerHTML = "Confirm & Add Matches";
							confirmBtn.classList.remove("btn-danger");
							confirmBtn.classList.add("btn-success");
							confirmBtn.removeAttribute("title");
						}

					});

					clone.querySelectorAll("input[type='hidden']").forEach(i => i.remove());

					body.appendChild(clone);
				});


				modal.show();
			});

			document.getElementById("confirmAddUpcoming")
				.addEventListener("click", () => {
					form.submit();
			});
		});


		document.addEventListener("click", async function (e) {

			const btn = e.target.closest(".stop-boost-btn");
			if (!btn) return;

			const boostId = btn.dataset.boostId;
			if (!boostId) return;

			if (!confirm("Stop this boost immediately?")) return;

			// disable to prevent double clicks
			btn.disabled = true;

			try {
				const token = document.querySelector(
					"input[name='__RequestVerificationToken']"
				)?.value;

				const res = await fetch("/Event/StopOddsBoost", {
					method: "POST",
					headers: {
						"Content-Type": "application/json",
						"RequestVerificationToken": token
					},
					body: JSON.stringify({ oddsBoostId: boostId })
				});

				if (!res.ok) {
					throw new Error("Failed to stop boost");
				}

				location.reload(); // RELOAD THE PAGE ! 

			} catch (err) {
				console.error(err);
				alert("Failed to stop boost.");
				btn.disabled = false;
			}
		});

		function renderCreateBoostButton(matchEventId) {

			const wrapper = document.createElement("span");
			wrapper.className = "custom-tooltip-wrapper";

			const button = document.createElement("button");
			button.type = "button";
			button.className = "btn btn-sm btn-warning create-boost-btn";
			button.setAttribute("data-bs-toggle", "modal");
			button.setAttribute("data-bs-target", "#createBoostModal");
			button.setAttribute("data-match-id", matchEventId);

			const icon = document.createElement("i");
			icon.className = "ri-fire-fill";

			button.appendChild(icon);

			const tooltip = document.createElement("span");
			tooltip.className = "custom-tooltip text-bg-warning";
			tooltip.textContent = "Add an odds boost for this game";

			wrapper.appendChild(button);
			wrapper.appendChild(tooltip);

			return wrapper;
		}

		function renderActiveBoostControls(boostId, boostEndUtc) {

			const container = document.createElement("div");
			container.className = "d-flex flex-column align-items-center gap-1";

			const stopBtn = document.createElement("button");
			stopBtn.type = "button";
			stopBtn.className = "btn btn-sm btn-outline-danger stop-boost-btn";
			stopBtn.dataset.boostId = boostId;

			const icon = document.createElement("i");
			icon.className = "ri-stop-circle-line";
			stopBtn.appendChild(icon);
			stopBtn.append(" Stop");

			const countdown = document.createElement("span");
			countdown.className = "boost-countdown fw-bold";
			countdown.dataset.boostEnd = boostEndUtc;

			container.appendChild(stopBtn);
			container.appendChild(countdown);

			return container;
		}


		function startBoostCountdown(countdownEl) {
			if (!countdownEl) return;

			const endTime = new Date(countdownEl.dataset.boostEnd);
			let intervalId = null;

			function update() {
				const now = new Date(); // local browser time
				const diff = endTime.getTime() - now.getTime();

				if (diff <= 0) {
					countdownEl.textContent = "Expired";
					clearInterval(intervalId);
					return;
				}

				const minutes = Math.floor(diff / 1000 / 60);
				const seconds = Math.floor((diff / 1000) % 60);
				countdownEl.textContent = `${minutes}m ${seconds}s`;
			}

			update();
			intervalId = setInterval(update, 1000);
		}


	</script>
}
