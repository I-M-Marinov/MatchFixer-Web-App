@using MatchFixer.Core.ViewModels.LiveEvents
@model MatchEventFormModel

@{
	ViewData["Title"] = "Create and View Events";
}

<div class="game-background"></div>

<div class="border-0 rounded-4 p-2 flex-fill">
	@if (TempData["SuccessMessage"] != null)
	{
		<div class="alert success-message" id="success-message">
			@TempData["SuccessMessage"]
		</div>
	}

	@if (TempData["ErrorMessage"] != null)
	{
		<div class="alert error-message" id="error-message">
			@TempData["ErrorMessage"]
		</div>
	}

</div>

<ul class="nav nav-tabs mb-3 justify-content-center add-event-navigation-tabs" id="eventTabs" role="tablist">
	<li class="nav-item" role="presentation">
		<button class="nav-link active"
		        data-bs-toggle="tab"
		        data-bs-target="#manualTab"
		        type="button"
		        role="tab">
			Manual Event
		</button>
	</li>

	<li class="nav-item" role="presentation">
		<button class="nav-link"
		        data-bs-toggle="tab"
		        data-bs-target="#apiTab"
		        type="button"
		        role="tab">
			Upcoming Matches
		</button>
	</li>
</ul>


<div class="tab-content">

	<div class="tab-pane fade show active" id="manualTab" role="tabpanel">
			<div class="modal fade" id="createBoostModal" tabindex="-1" aria-hidden="true">
				<div class="modal-dialog">
					<div class="modal-content">
						<form id="createBoostForm">
							@Html.AntiForgeryToken()
							<div class="modal-header">
								<h5 class="modal-title">Create Odds Boost</h5>
								<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
							</div>

							<div class="modal-body">
								<input type="hidden" name="MatchEventId" id="MatchEventId" />

								<!-- Boost Value + Duration (same row) -->
								<div class="row">
									<div class="col-md-6 mb-3">
										<label class="form-label">Boost Value</label>
										<input type="number" step="0.01" class="form-control" name="BoostValue" required />
									</div>
									<div class="col-md-6 mb-3">
										<label class="form-label">Duration (minutes)</label>
										<input type="number" class="form-control" name="DurationMinutes" value="30" />
									</div>
								</div>

								<!-- Max Stake + Max Uses (same row) -->
								<div class="row">
									<div class="col-md-6 mb-3">
										<label class="form-label">Max Stake Per Bet</label>
										<input type="number" step="0.01" class="form-control" name="MaxStakePerBet" />
									</div>
									<div class="col-md-6 mb-3">
										<label class="form-label">Max Uses Per User</label>
										<input type="number" class="form-control" name="MaxUsesPerUser" />
									</div>
								</div>

								<!-- Start Time -->
								<div class="mb-3 d-flex align-items-center">
									<label class="form-label">Start Time (UTC)</label>
									<input type="datetime-local" class="form-control" name="StartUtc" />
									<small class="form-text text-muted">Leave empty to start immediately.</small>
								</div>

								<!-- Note -->
								<div class="mb-3 d-flex align-items-center">
									<label class="form-label">Note</label>
									<input type="text" class="form-control" name="Note" />
								</div>
							</div>

							<div class="modal-footer">
								<button type="submit" class="btn btn-primary">Create</button>
							</div>
						</form>
					</div>
				</div>
			</div>


			<div class="position-relative">
				<div id="model-error-add-event" asp-validation-summary="ModelOnly"
					 class="position-absolute start-50 translate-middle-x"
					 style="top: -80px; white-space: nowrap; z-index: 1005;">
				</div>

			@* <div class="d-flex justify-content-center align-items-start flex-wrap gap-1 mt-1">*@				
			<div class="events-layout">


			<div class="add-match-event-container mt-4">
				<form id="team-selection-form" asp-action="AddMatchEvent" asp-controller="Event" method="post" class="needs-validation" novalidate>
					@Html.AntiForgeryToken()
					<div class="teams-information d-flex justify-content-center align-items-center gap-5 mb-3">
						<div class="col">
							<div class="text-center my-2">
								<img id="home-team-logo"
								     src="/images/add-match/question-mark.png"
								     alt="Home Team Logo"
								     class="team-logo"
								     style="max-height: 75px; margin-bottom:1em;"/>
							</div>
							<select asp-for="HomeTeamId" id="home-team-select" class="form-control">
								<option value="">-- Select Home Team --</option>
								@foreach (var league in Model.TeamsByLeague)
								{
									<optgroup class="add-team-league-label" label="@league.Key">
										@foreach (var team in league.Value)
										{
											var logoUrl = team.Text.Split('|').ElementAtOrDefault(1);
											var teamName = team.Text.Split('|').FirstOrDefault();
											<option value="@team.Value" data-logo="@logoUrl">@teamName</option>
										}
									</optgroup>
								}
							</select>
							<span asp-validation-for="HomeTeamId" class="bg-info validation-add-event centered-validation"></span>
						</div>

						<div class="col">
							<div class="text-center my-2">
								<img id="away-team-logo"
								     src="/images/add-match/question-mark.png"
								     alt="Away Team Logo"
								     class="team-logo"
								     style="max-height: 75px; margin-bottom:1em;"/>
							</div>
							<select asp-for="AwayTeamId" id="away-team-select" class="form-control">
								<option value="">-- Select Away Team --</option>
								@foreach (var league in Model.TeamsByLeague)
								{
									<optgroup class="add-team-league-label" label="@league.Key">
										@foreach (var team in league.Value)
										{
											var logoUrl = team.Text.Split('|').ElementAtOrDefault(1);
											var teamName = team.Text.Split('|').FirstOrDefault();
											<option value="@team.Value" data-logo="@logoUrl">@teamName</option>
										}
									</optgroup>
								}
							</select>
							<span asp-validation-for="AwayTeamId" class="bg-info validation-add-event centered-validation"></span>
						</div>
					</div>

					<div id="dateAndTime" class="mb-3">
						<label asp-for="MatchDate" class="form-label">Date and Time</label>
						<input asp-for="MatchDate" class="form-control" type="datetime-local" value="@Model.MatchDate.ToString("yyyy-MM-ddTHH:mm")"/>
						<span asp-validation-for="MatchDate" class="bg-info validation-add-event centered-validation"></span>
					</div>

					<div class="d-flex justify-content-center align-items-center row mb-3">
						<div class="home-odds col">
							<label asp-for="HomeOdds" class="form-label">Home Team Win</label>
							<input asp-for="HomeOdds" class="form-control"/>
							<span asp-validation-for="HomeOdds" class="bg-info validation-add-event centered-validation"></span>
						</div>
						<div class="draw-odds col">
							<label asp-for="DrawOdds" class="form-label">Draw</label>
							<input asp-for="DrawOdds" class="form-control"/>
							<span asp-validation-for="DrawOdds" class="bg-info validation-add-event centered-validation"></span>

						</div>
						<div class="away-odds col">
							<label asp-for="AwayOdds" class="form-label">Away Team Win</label>
							<input asp-for="AwayOdds" class="form-control"/>
							<span asp-validation-for="AwayOdds" class="bg-info validation-add-event centered-validation"></span>

						</div>
					</div>

					<span class="custom-add-match-tooltip-wrapper">
						<button type="submit" class="btn add-event-icon-container">
							<div class="text-center my-2">
								<img id="add-event-icon"
								     src="/images/add-match/add-event.png"
								     alt="Add Event"
								     style="max-height: 85px;"/>
							</div>
							<span class="custom-add-match-tooltip">Add this game to the Events Board</span>
						</button>


					</span>

				</form>
			</div>


			<div class="live-events-section mt-3 mx-auto" style="max-width: 1400px;">
				<h3 class="text-center mb-2">Current Live Events</h3>
				<ul class="nav nav-pills justify-content-center mb-3" id="eventDateTabs"></ul>

				@if (Model.CurrentEvents.Any())
				{
					<div class="table-responsive">

						<div class="live-events-table-wrapper">
							<table class="responsive-stack table table-bordered table-hover text-center shadow-sm rounded-3 table-sm align-middle"
							       id="live-events-table">
								<thead class="table-dark">
								<tr>
									<th>Status</th>
									<th>Date & Time (local)</th>
									<th>Home Team</th>
									<th>Away Team</th>
									<th>Boost</th>
									<th>Update</th>
								</tr>
								</thead>
								<tbody>
								@foreach (var ev in Model.CurrentEvents)
								{
									<tr class="@(ev.ApiFixtureId > 0 ? "api-imported-match" : "")"
									    data-date="@ev.KickoffTime.ToLocalTime().Date.ToString("yyyy-MM-dd")">
										<td>
											@switch (ev.MatchStatus)
											{
												case "Live":
													<span class="badge bg-success">Live</span>
													break;
												case "Started":
													<span class="badge bg-warning text-dark">Started</span>
													break;
												case "Cancelled":
													<span class="badge bg-danger">Cancelled</span>
													break;
											}
											@if (ev.ApiFixtureId != null)
											{
												<span class="badge bg-info ms-1">auto</span>
											}
										</td>
										<td>
											@ev.KickoffTime.ToLocalTime().ToString("g")
										</td>
										<td>
											<img src="@ev.HomeTeamLogoUrl" alt="@ev.HomeTeam Logo" style="height: 40px; width:auto; margin-right: 5px;"/>
											@ev.HomeTeam
										</td>
										<td>
											<img src="@ev.AwayTeamLogoUrl" alt="@ev.AwayTeam Logo" style="height: 40px; width:auto; margin-right: 5px;"/>
											@ev.AwayTeam
										</td>
										<td>
											@if (ev.BoostActive != null)
											{
												<div class="d-flex flex-column align-items-center boost-timer-row"
												     data-boost-end="@ev.BoostActive.EndUtc.ToString("yyyy-MM-ddTHH:mm:ssZ")">
													<span class="badge bg-success mb-1">Boost Active!</span>
													<span class="boost-countdown fw-bold"></span>
												</div>
											}
											else
											{
												<span class="custom-tooltip-wrapper">
													@if (ev.MatchStatus == "Started")
													{
														<button type="button" class="btn btn-sm btn-outline-danger create-boost-btn text-muted"
														        data-match-id="@ev.Id" disabled>
															<i class="ri-fire-fill"></i>
														</button>
														<span class="custom-tooltip text-bg-info">Cannot add a boost to a game that already started!</span>
													}
													else
													{
														<button type="button" class="btn btn-sm btn-warning create-boost-btn"
														        data-bs-toggle="modal"
														        data-bs-target="#createBoostModal"
														        data-match-id="@ev.Id">
															<i class="ri-fire-fill"></i>
														</button>
														<span class="custom-tooltip text-bg-warning">Add an odds boost for this game</span>
													}
												</span>

											}
										</td>
										<td style="max-width: 350px;">
											<div class="d-flex justify-content-center align-items-center flex-wrap">

												<div class="d-flex flex-column gap-1">

													@{
														var isDisabled = (ev.MatchStatus == "Started" || ev.ActiveBoost != null) ? "disabled" : "";
													}


													<div class="d-flex gap-2">
														<input type="number" id="HomeOddsInput-@ev.Id" data-id="@ev.Id" step="0.01"
														       value="@ev.HomeWinOdds" class="form-control form-control-sm home-odds-style" style="width: 80px;" placeholder="Home" @isDisabled/>
														<input type="number" id="DrawOddsInput-@ev.Id" data-id="@ev.Id" step="0.01"
														       value="@ev.DrawOdds" class="form-control form-control-sm draw-odds-style" style="width: 80px;" placeholder="Draw" @isDisabled/>
														<input type="number" id="AwayOddsInput-@ev.Id" data-id="@ev.Id" step="0.01"
														       value="@ev.AwayWinOdds" class="form-control form-control-sm away-odds-style" style="width: 80px;" placeholder="Away" @isDisabled/>

													</div>

													<input type="datetime-local" id="MatchDateInput-@ev.Id" data-id="@ev.Id"
													       value="@ev.KickoffTime.ToString("yyyy-MM-ddTHH:mm")"
													       class="form-control form-control-sm matchdate-style" style="min-width: 240px;" @isDisabled/>
												</div>

												<div class="d-flex flex-column gap-1 align-items-end">
													@if (ev.MatchStatus != "Started")
													{
														<form asp-action="EditMatchEvent" asp-controller="Event" method="post" class="d-inline" id="editForm-@ev.Id">
															@Html.AntiForgeryToken()
															<input type="hidden" name="Id" value="@ev.Id"/>
															<input type="hidden" name="HomeOdds" id="HiddenHomeOdds-@ev.Id"/>
															<input type="hidden" name="DrawOdds" id="HiddenDrawOdds-@ev.Id"/>
															<input type="hidden" name="AwayOdds" id="HiddenAwayOdds-@ev.Id"/>
															<input type="hidden" name="MatchDate" id="HiddenMatchDate-@ev.Id"/>

															<span class="custom-save-remove-tooltip-wrapper">
																<button type="submit" class="btn btn-outline-success btn-sm update-event-btn">
																	<div class="icon">
																		<i class="bx bxs-save"></i>
																	</div>
																</button>
																<span class="custom-save-remove-tooltip">Save the event</span>
															</span>
														</form>
													}

													@if (ev.IsCancelled != true)
													{
														<form asp-action="CancelMatchEvent" asp-controller="Event" method="post" class="d-inline">
															@Html.AntiForgeryToken()
															<input type="hidden" name="id" value="@ev.Id"/>
															<span class="custom-save-remove-tooltip-wrapper">
																<button type="button"
																        class="btn btn-outline-danger btn-sm update-event-btn"
																        data-bs-toggle="modal"
																        data-bs-target="#confirmCancelModal"
																        data-event-id="@ev.Id">
																	<div class="icon">
																		<i class="ri-delete-bin-2-fill"></i>
																		<div class="label"></div>
																	</div>
																</button>
																<span class="custom-save-remove-tooltip">Cancel the event</span>
															</span>

														</form>
													}
												</div>

											</div>
										</td>

									</tr>
								}
								</tbody>
							</table>
						</div>
					</div>
				}
				else
				{
					<div class="alert alert-info text-center">
						There are no live or started events available.
					</div>
				}

			</div>
			</div>

			</div>


			<div class="modal fade" id="confirmCancelModal" tabindex="-1" aria-labelledby="confirmCancelLabel" aria-hidden="true">
				<div class="modal-dialog modal-dialog-centered">
					<div class="modal-content border-danger">
						<div class="modal-header text-danger fw-bold">
							<h5 class="modal-title" id="confirmCancelLabel">
								<i class="bi bi-exclamation-triangle-fill me-2"></i>
								Confirm Cancellation
							</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
						</div>
						<div class="modal-body text-center">
							Are you sure you want to void this event?
						</div>
						<div class="modal-footer justify-content-center">
							<form id="cancelEventForm" asp-action="CancelMatchEvent" asp-controller="Event" method="post">
								@Html.AntiForgeryToken()
								<input type="hidden" name="id" id="cancelEventId" value="" />
								<button type="submit" class="btn btn-danger">Yes, Void</button>
							</form>
							<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No, Go Back</button>
						</div>
					</div>
				</div>
			</div>
		</div>

	<div class="tab-pane fade" id="apiTab" role="tabpanel">
		<div class="card shadow-sm p-3 add-match-auto-card">

			<form id="addUpcomingForm" asp-action="AddUpcomingMatches" asp-controller="Event" method="post">
					@Html.AntiForgeryToken()
					<div class="row mb-3 align-items-end">
						<div class="col-md-4">
							<label class="form-label">League</label>
							<select id="apiLeagueSelect" class="form-select">
								<option value="">Select league</option>
								@foreach (var league in Model.ApiLeagues)
								{
									<option value="@league.ApiLeagueId">@league.Name</option>
								}
							</select>
						</div>

						<div class="col-md-3">
							<button type="button" id="loadUpcomingBtn" class="btn btn-primary">
								Load upcoming matches
							</button>
						</div>
					</div>

					<div class="table-responsive api-upcoming-matches-table">
						<table class="table table-sm table-hover align-middle text-center">
							<thead class="table-dark">
							<tr>
								<th>Add</th>
								<th>Date</th>
								<th>Home</th>
								<th>Away</th>
								<th>H</th>
								<th>D</th>
								<th>A</th>
							</tr>
							</thead>
							<tbody id="apiMatchesBody">
							<tr>
								<td colspan="7" class="text-muted">
									Select a league to load upcoming matches
								</td>
							</tr>
							</tbody>
						</table>
					</div>

					<div class="text-end mt-3">
						<button type="submit" class="btn btn-success">
							Add selected matches
						</button>
					</div>

			</form>

		</div>
	</div>

</div>



@section Scripts {
	<partial name="_ValidationScriptsPartial" />

	<script>

		function logoChange(selectId, logoImgId, placeholder) {
			const select = document.getElementById(selectId);
			const logoImg = document.getElementById(logoImgId);

			select.addEventListener('change', function () {
				const selectedOption = select.options[select.selectedIndex];
				const logoUrl = selectedOption.getAttribute('data-logo');

				if (selectedOption.value === "" || !logoUrl) {
					logoImg.src = placeholder;
				} else {
					logoImg.src = logoUrl;
				}
			});
		}

		const placeholderImage = '/images/add-match/question-mark.png';

		logoChange('home-team-select', 'home-team-logo', placeholderImage);
		logoChange('away-team-select', 'away-team-logo', placeholderImage);

		document.addEventListener('DOMContentLoaded', function () {

			document.querySelectorAll("form[id^='editForm-']").forEach(form => {

				form.addEventListener('submit', function (e) {

					const id = form.querySelector("input[name='Id']").value;

					const homeVal = document.getElementById(`HomeOddsInput-${id}`).value;
					const drawVal = document.getElementById(`DrawOddsInput-${id}`).value;
					const awayVal = document.getElementById(`AwayOddsInput-${id}`).value;
					const dateVal = document.getElementById(`MatchDateInput-${id}`).value;

					document.getElementById(`HiddenHomeOdds-${id}`).value = homeVal;
					document.getElementById(`HiddenDrawOdds-${id}`).value = drawVal;
					document.getElementById(`HiddenAwayOdds-${id}`).value = awayVal;
					document.getElementById(`HiddenMatchDate-${id}`).value = dateVal;

				});
			});
		});



		document.addEventListener('DOMContentLoaded', function () {

			const confirmModal = document.getElementById('confirmCancelModal');

			confirmModal.addEventListener('show.bs.modal', function (event) {
				const button = event.relatedTarget;
				const eventId = button.getAttribute('data-event-id');
				document.getElementById('cancelEventId').value = eventId;
			});

		});

		document.addEventListener("DOMContentLoaded", () => {
			const form = document.getElementById("createBoostForm");
			const matchIdInput = document.getElementById("MatchEventId");

			// When modal is triggered, set the hidden field
			document.querySelectorAll(".create-boost-btn").forEach(btn => {
				btn.addEventListener("click", () => {
					const matchId = btn.getAttribute("data-match-id");
					matchIdInput.value = matchId;
				});
			});

			form.addEventListener("submit", async function (e) {
				e.preventDefault();

				const formData = new FormData(form);

				// Convert local datetime-local to UTC
				const startInput = form.querySelector("input[name='StartUtc']");
				if (startInput && startInput.value) {
					const localDate = new Date(startInput.value);
					formData.set("StartUtc", localDate.toISOString());
				}

				// Get anti-forgery token
				const tokenInput = form.querySelector("input[name='__RequestVerificationToken']");
				const token = tokenInput ? tokenInput.value : "";

				try {
					const response = await fetch("/Event/CreateOddsBoost", {
						method: "POST",
						body: formData,
						headers: {
							"RequestVerificationToken": token
						}
					});

					if (!response.ok) throw new Error(`HTTP error ${response.status}`);

					const result = await response.json();

					if (result.success) {
						alert("Promo created successfully!");
						location.reload();
					} else {
						alert("Error: " + (result.message || "Unknown error occurred."));
					}
				} catch (err) {
					console.error("Request failed", err);
					alert("Request failed: " + err.message);
				}
			});
		});


		document.addEventListener("DOMContentLoaded", () => {
			document.querySelectorAll(".boost-timer-row").forEach(row => {
				const countdown = row.querySelector(".boost-countdown");
				const endTime = new Date(row.dataset.boostEnd); // parsed as UTC

				function update() {
					const now = new Date(); // local browser time
					const diff = endTime.getTime() - now.getTime();

					if (diff <= 0) {
						countdown.textContent = "Expired";
						return clearInterval(interval);
					}

					const minutes = Math.floor(diff / 1000 / 60);
					const seconds = Math.floor((diff / 1000) % 60);
					countdown.textContent = `${minutes}m ${seconds}s`;
				}

				update();
				const interval = setInterval(update, 1000);
			});
		});


		document.addEventListener("DOMContentLoaded", function () {
			const connection = new signalR.HubConnectionBuilder()
				.withUrl("/matchEventHub")
				.withAutomaticReconnect()
				.build();

			connection.start()
				.then(() => {
					console.log("SignalR connected");
					document.querySelectorAll('.event-card').forEach(card => {
						const matchId = card.dataset.matchId;
						console.log("Subscribing to match", matchId);
						connection.invoke("SubscribeToEvent", matchId)
							.then(() => console.log("Subscribed to", matchId))
							.catch(err => console.error(`Failed to subscribe to match ${matchId}:`, err.toString()));
					});
			})

			connection.on("MatchEventUpdated", function (update) {
				const card = document.querySelector(`[data-match-id="${update.matchEventId}"]`);
				if (!card) return;

				const homeOddsElement = card.querySelector('tbody span[data-option="Home"]');
				const drawOddsElement = card.querySelector('tbody span[data-option="Draw"]');
				const awayOddsElement = card.querySelector('tbody span[data-option="Away"]');

				const homeHeader = card.querySelector('thead th[data-option="Home"]');
				const drawHeader = card.querySelector('thead th[data-option="Draw"]');
				const awayHeader = card.querySelector('thead th[data-option="Away"]');

				const hasBoost = update.activeBoostId != null;

				if (!hasBoost) {

						if (homeOddsElement && homeHeader) {
							homeHeader.dataset.odds = update.homeOdds;
							animateOddsChange(homeOddsElement, update.homeOdds, update.matchEventId, "Home", false);
						}

						if (drawOddsElement && drawHeader) {
							drawHeader.dataset.odds = update.drawOdds;
							animateOddsChange(drawOddsElement, update.drawOdds, update.matchEventId, "Draw", false);
						}

						if (awayOddsElement && awayHeader) {
							awayHeader.dataset.odds = update.awayOdds;
							animateOddsChange(awayOddsElement, update.awayOdds, update.matchEventId, "Away", false);
						}
				} else {
					animateOddsChange(homeOddsElement, update.effectiveHomeOdds, update.matchEventId, "Home", true);
					animateOddsChange(drawOddsElement, update.effectiveDrawOdds, update.matchEventId, "Draw", true);
					animateOddsChange(awayOddsElement, update.effectiveAwayOdds, update.matchEventId, "Away", true);

					if (homeHeader) homeHeader.dataset.odds = update.effectiveHomeOdds.toFixed(2);
					if (drawHeader) drawHeader.dataset.odds = update.effectiveDrawOdds.toFixed(2);
					if (awayHeader) awayHeader.dataset.odds = update.effectiveAwayOdds.toFixed(2);
				}
			});

		connection.on("BoostStarted", function(boostData) {

			const card = document.querySelector(`[data-match-id="${boostData.matchEventId}"]`) ||
			document.querySelector(`[data-match-id='${boostData.matchEventId.toString()}']`);

			if (!card) return;
			const oddsRow = card.querySelector(".tw-divide-y .tw-divide-gray-200");

			activateBoost(oddsRow, boostData);
			});

		});

		// Football API request from the Admin

		document.getElementById("loadUpcomingBtn").addEventListener("click", async () => {
			const leagueId = document.getElementById("apiLeagueSelect").value;
			if (!leagueId) {
				alert("Select a league first");
				return;
			}

			const res = await fetch(`/Event/UpcomingFromApi?leagueId=${leagueId}`);
			document.getElementById("apiMatchesBody").innerHTML = await res.text();
		});

				
		document.addEventListener("DOMContentLoaded", () => {
			const upcomingForm = document.getElementById("addUpcomingForm");

			if (upcomingForm) {
				upcomingForm.addEventListener("submit", function(e) {
					e.preventDefault();

					const checkedBoxes = document.querySelectorAll("#apiMatchesBody input[type=checkbox]:checked");

					if (checkedBoxes.length === 0) {
						alert("Select at least one match.");
						return;
					}

					document.querySelectorAll("#apiMatchesBody input[type=checkbox]:not(:checked)")
						.forEach(cb => cb.closest('tr').remove());

					const tbody = document.getElementById("apiMatchesBody");
					const rows = tbody.querySelectorAll("tr");

					rows.forEach((row, newIndex) => {
						// Only process inputs INSIDE the tbody rows, not the anti-forgery token
						row.querySelectorAll("input").forEach(input => {
							const name = input.getAttribute("name");
							if (name && name.startsWith("Selected[")) {  
								const newName = name.replace(/Selected\[\d+\]/, `Selected[${newIndex}]`);
								input.setAttribute("name", newName);
							}
						});
					});

					// Verify anti-forgery token exists before submitting
					const token = this.querySelector("input[name='__RequestVerificationToken']");
					if (!token) {
						console.error("Anti-forgery token missing!");
						alert("Security token missing. Please refresh the page.");
						return;
					}

					this.submit();
				});
			}
		});



		document.addEventListener("DOMContentLoaded", () => {
			const rows = [...document.querySelectorAll("#live-events-table tbody tr")];
			const tabs = document.getElementById("eventDateTabs");

			if (!rows.length) return;

			const uniqueDates = [...new Set(rows.map(r => r.dataset.date))].slice(0, 5);

			const today = new Date();
			today.setHours(0,0,0,0);

			function labelFor(dateStr) {
				const d = new Date(dateStr + "T00:00:00");
				const diff = (d - today) / 86400000;

				if (diff === 0) return "Today";
				if (diff === 1) return "Tomorrow";

				return d.toLocaleDateString(undefined, {
					weekday: "short",
					day: "numeric",
					month: "short"
				});
			}

			function filter(date) {
				rows.forEach(r => {
					if (date === "all") {
						r.style.display = "";
					} else {
						r.style.display = r.dataset.date === date ? "" : "none";
					}
				});
			}

			const allLi = document.createElement("li");
				allLi.className = "nav-item";
				allLi.innerHTML = `
					<button class="nav-link active" data-date="all">
						All
					</button>
				`;
		tabs.appendChild(allLi);

			uniqueDates.forEach((date, i) => {
				const li = document.createElement("li");
				li.className = "nav-item";

				li.innerHTML = `
					<button class="nav-link"
							data-date="${date}">
						${labelFor(date)}
					</button>
				`;

				tabs.appendChild(li);
			});

			tabs.addEventListener("click", e => {
				if (!e.target.dataset.date) return;

				tabs.querySelectorAll(".nav-link").forEach(b => b.classList.remove("active"));
				e.target.classList.add("active");

				filter(e.target.dataset.date);
			});
		});

	</script>
}
